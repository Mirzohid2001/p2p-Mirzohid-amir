{% extends 'base.html' %}
{% load static %}

{% block title %}Мой профиль{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/modern-profile.css' %}">
{% endblock %}

{% block content %}
<div class="profile-container">


    <div class="balance-card">
        <h2 class="balance-card-title"><i class="fas fa-wallet"></i> Ваш баланс</h2>
        <div class="balance-item">
            <div class="balance-token">
                <div class="token-icon cf" style="position:relative; width:54px; height:54px; display:inline-flex; align-items:center; justify-content:center; padding: 30px">
    <img src="{% static 'images/coin.png' %}" style="position:absolute; left:0; top:0; width:100%; height:100%; opacity:0.85; z-index:1;">
</div>
                <div class="token-info">
                    <span class="token-name">FLORA Токены</span>
                    <span class="token-description">Основная игровая валюта</span>
                </div>
            </div>
            <div class="token-amount">{{ cf_balance|floatformat:1 }}</div>
        </div>
        <div class="balance-item">
            <div class="balance-token">
                <div class="token-icon ton" style="position:relative; width:54px; height:54px; display:inline-flex; align-items:center; justify-content:center;padding: 30px">
    <img src="{% static 'images/ton.png' %}" style="position:absolute; left:0; top:0; width:100%; height:100%; opacity:0.85; z-index:1;">

</div>
                <div class="token-info">
                    <span class="token-name">TON Токены</span>
                    <span class="token-description">Торговая валюта</span>
                </div>
            </div>
            <div class="token-amount">{{ ton_balance|floatformat:1 }}</div>
        </div>
    </div>
<div class="ton-section" style="margin: 2rem auto 1rem; padding: 1.5rem; border-radius: 1.1rem; background: #233; max-width: 400px; text-align: center;">
    <div id="ton-connect"></div>
    <div id="wallet-status"></div>
    <div id="ton-topup-block" style="display:none;">
        <input type="number" id="topup-amount" min="0.01" step="0.01" placeholder="Сумма TON">
        <button id="send-ton-btn">Пополнить TON</button>
    </div>
    <div id="ton-result"></div>

<!-- Кнопка Вывод -->
<div style="margin-top: 12px;">
  <button id="withdraw-ton-btn" style="
      width: 100%;
      padding: 12px 14px;
      border: none;
      border-radius: 12px;
      font-weight: 700;
      cursor: pointer;
      background: linear-gradient(90deg,#3a247a 10%, #368fff 100%);
      color: #fff;
      box-shadow: 0 6px 20px rgba(0,0,0,.25);
  ">Вывод</button>
</div>

<!-- Модалка Вывод -->
<div id="withdraw-modal" style="
    display:none;
    position:fixed;
    inset:0;
    z-index:9999;
    background: rgba(0,0,0,.55);
    backdrop-filter: blur(6px);
    align-items:center;
    justify-content:center;
    padding: 18px;
">
  <div style="
      width: 100%;
      max-width: 420px;
      border-radius: 18px;
      background: linear-gradient(90deg,#3a247a 10%, #368fff 100%);
      padding: 22px 18px 16px;
      box-shadow: 0 12px 40px rgba(0,0,0,.35);
      position: relative;
      text-align:center;
      color:#fff;
  ">
    <button id="withdraw-modal-close" type="button" style="
        position:absolute;
        right:12px; top:10px;
        width:36px; height:36px;
        border:none;
        border-radius:10px;
        background: rgba(255,255,255,.12);
        color:#fff;
        font-size:22px;
        cursor:pointer;
    ">&times;</button>

    <div style="font-size: 1.2rem; font-weight: 800; margin-bottom: 10px;">
      Вывод
    </div>
    <div style="font-size: 1.02rem; color: rgba(255,255,255,.92); line-height: 1.35;">
      Вывод будет доступен после открытия P2P маркета
    </div>

    <button id="withdraw-modal-ok" type="button" style="
        margin-top: 14px;
        width:100%;
        padding: 12px 14px;
        border:none;
        border-radius: 12px;
        font-weight: 800;
        cursor:pointer;
        background: rgba(0,0,0,.18);
        color:#fff;
        box-shadow: inset 0 0 0 1px rgba(255,255,255,.18);
    ">OK</button>
  </div>
</div>

</div>


        <div class="trees-section">
            <h2 class="balance-card-title"><i class="fas fa-tree"></i> Ваши деревья</h2>
            {% for tree in trees %}
            <div class="tree-item">
                <div class="tree-info">
                    <div class="tree-icon {{ tree.type|lower }}" style="width:38px;height:38px;position:relative;display:inline-flex;align-items:center;justify-content:center;background: none !important">
                {% if tree.type == 'CF' %}
                    <img src="{% static 'images/coin.png' %}" alt="FLORA" style="width:100%;height:100%;object-fit:contain;">
                {% elif tree.type == 'TON' %}
                    <img src="{% static 'images/ton.png' %}" alt="TON" style="width:100%;height:100%;object-fit:contain;">
                {% endif %}
            </div>
                    <div class="tree-details">
                        <span class="tree-type">{{ tree.get_type_display }}</span>
                        <span class="tree-level">Уровень {{ tree.level }}</span>
                    </div>
                </div>
                <div class="tree-income">
                    <i class="fas fa-coins"></i> {{ tree.income_per_hour|floatformat:1 }}/час
                </div>
            </div>
            {% empty %}
            <p class="text-center" style="color: rgba(255, 255, 255, 0.6);">У вас пока нет деревьев</p>
            {% endfor %}
        </div>


</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const copyBtn = document.getElementById('copy-btn');
        const refLink = document.getElementById('ref-link');
        if (copyBtn && refLink) {
            copyBtn.addEventListener('click', function() {
                const tempInput = document.createElement('input');
                tempInput.value = refLink.textContent.trim();
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                const originalText = copyBtn.innerHTML;
                copyBtn.innerHTML = '<i class="fas fa-check"></i> Скопировано!';
                copyBtn.classList.add('copied');

                setTimeout(() => {
                    copyBtn.innerHTML = originalText;
                    copyBtn.classList.remove('copied');
                }, 2000);
            });
        }
        // ====== Withdraw modal ======
const withdrawBtn = document.getElementById('withdraw-ton-btn');
const withdrawModal = document.getElementById('withdraw-modal');
const withdrawClose = document.getElementById('withdraw-modal-close');
const withdrawOk = document.getElementById('withdraw-modal-ok');

function openWithdrawModal() {
  if (!withdrawModal) return;
  withdrawModal.style.display = 'flex';
  document.body.style.overflow = 'hidden';
}
function closeWithdrawModal() {
  if (!withdrawModal) return;
  withdrawModal.style.display = 'none';
  document.body.style.overflow = '';
}

if (withdrawBtn) withdrawBtn.addEventListener('click', openWithdrawModal);
if (withdrawClose) withdrawClose.addEventListener('click', closeWithdrawModal);
if (withdrawOk) withdrawOk.addEventListener('click', closeWithdrawModal);

// закрытие по клику на фон
if (withdrawModal) {
  withdrawModal.addEventListener('click', (e) => {
    if (e.target === withdrawModal) closeWithdrawModal();
  });
}

    });

</script>

<script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // TON Connect setup
    const tonConnectRootId = 'ton-connect';
    const tonConnectManifest = 'https://flora.diy/static/tonconnect-manifest.json'; // путь к manifest.json
    const tonRecipient = 'UQAaSqEaBNAXz4gz7oJvrYXLaKXGaoUcxXFKR4rdW8KPwzLp';   // сюда будут приходить TON

    if (typeof TON_CONNECT_UI === "undefined") {
        alert("TON_CONNECT_UI не загружен. Проверь ссылку на скрипт!");
        return;
    }

    const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
        manifestUrl: tonConnectManifest,
        buttonRootId: tonConnectRootId
    });

    let walletConnected = false;
    let wallet = null;
    const userTgId = "{{ user.telegram_id }}";
    const walletStatus = document.getElementById('wallet-status');
    const topupBlock = document.getElementById('ton-topup-block');
    const sendTonBtn = document.getElementById('send-ton-btn');
    const topupAmount = document.getElementById('topup-amount');
    const resultBlock = document.getElementById('ton-result');
    function log(msg) {
    resultBlock.innerHTML += msg + "<br>";
}


    tonConnectUI.onStatusChange(async w => {
    wallet = w;
    if (wallet && wallet.account) {
        walletConnected = true;
        walletStatus.innerHTML = 'Кошелек подключен: <b>' + wallet.account.address.slice(0, 8) + '...</b>';
        topupBlock.style.display = '';
        // Сохраняем в БД
        try {
            await fetch("/save_wallet/", {
                method: "POST",
                headers: {"Content-Type": "application/x-www-form-urlencoded"},
                body: "address=" + encodeURIComponent(wallet.account.address)
            });
        } catch(e) { /* ничего */ }
    } else {
        walletConnected = false;
        walletStatus.textContent = 'Кошелек не подключён';
        topupBlock.style.display = 'none';
    }
    resultBlock.textContent = '';
});

    if (sendTonBtn) {
        function textCommentToPayloadBase64(comment) {
  const textBytes = new TextEncoder().encode(comment);
  const payload = new Uint8Array(4 + textBytes.length);
  payload[0]=0; payload[1]=0; payload[2]=0; payload[3]=0; // op=0
  payload.set(textBytes, 4);

  let bin = "";
  for (let i=0; i<payload.length; i++) bin += String.fromCharCode(payload[i]);
  return btoa(bin);
}

        sendTonBtn.onclick = async function() {
            if (!walletConnected || !wallet || !wallet.account) {
                alert("Сначала подключите TON кошелек!");
                return;
            }
            const amount = parseFloat(topupAmount.value);
            if (!amount || amount < 0.01) {
                alert('Введите сумму TON (например, 0.05)');
                return;
            }
            const amountNano = Math.round(amount * 1e9);
            const memo = "flora_" + userTgId;

            resultBlock.innerHTML = ""; // очистить лог
log("walletConnected=" + walletConnected);
log("recipient=" + tonRecipient);
log("amountNano=" + amountNano);
log("sending...");

            try {
                await tonConnectUI.sendTransaction({
  validUntil: Math.floor(Date.now() / 1000) + 600,
  messages: [{
    address: tonRecipient,
    amount: amountNano.toString()
  }]
});

                resultBlock.textContent = '✅ Транзакция отправлена! После подтверждения сетью баланс обновится автоматически.';
            } catch (e) {
                resultBlock.textContent = 'Ошибка или отмена: ' + (e.message || e);
            }
        }
    }
});
</script>

{% endblock %}
