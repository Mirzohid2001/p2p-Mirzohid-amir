{% extends "base.html" %}
{% load humanize %}
{% load i18n %}

{% block title %}P2P Биржа FL{% endblock %}

{% block content %}
<div class="cf-summary-block mb-4 animate-float">
    <div>{% trans "Создано FL" %}: {{ cf_created|intcomma }}</div>
    <div>{% trans "Выращено" %}: {{ cf_grown|floatformat:0|intcomma }}</div>
    <div>{% trans "Осталось" %}: {{ cf_left|floatformat:0|intcomma }}</div>
</div>


<!-- Цена TON и CF -->
<div class="flex justify-center items-center gap-6 mt-2 mb-4 text-white text-base" id="rates-bar">
  <div>
  {% trans "Цена FL" %}:
  <span class="font-bold" id="cf-price-value">{{ cf_price_rub }}</span>
  <span id="cf-price-currency">₽</span>
</div>

<div>
  TON:
  <span class="font-bold" id="ton-price-value">
    {% if ton_to_rub %}{{ ton_to_rub|floatformat:2 }}{% else %}—{% endif %}
  </span>
  <span id="ton-price-currency">₽</span>
</div>


  <!-- Переключатель валюты -->
  <div style="display:flex; align-items:center; gap:10px;">
    <button type="button" class="currency-btn active" data-currency="RUB">₽</button>
    <button type="button" class="currency-btn" data-currency="USD">$</button>
  </div>
</div>


<!-- График -->
<div class="chart-wrapper mb-4" style="position: relative; overflow: hidden;">
    <div class="chart-container" style="background: linear-gradient(135deg, rgba(90, 140, 255, 0.12) 0%, rgba(61, 80, 199, 0.15) 50%, rgba(90, 255, 117, 0.08) 100%); border-radius: 24px; border: 1px solid rgba(255, 255, 255, 0.15); box-shadow: 0 12px 40px rgba(0, 0, 0, 0.25), inset 0 0 60px rgba(90, 140, 255, 0.1); min-height: 240px; backdrop-filter: blur(15px); position: relative; padding: 20px;">
        <!-- Декоративные элементы -->
        <div style="position: absolute; top: 0; left: 0; width: 200px; height: 200px; background: radial-gradient(circle, rgba(90, 255, 117, 0.1) 0%, transparent 70%); border-radius: 50%; transform: translate(-50%, -50%); pointer-events: none;"></div>
        <div style="position: absolute; bottom: 0; right: 0; width: 150px; height: 150px; background: radial-gradient(circle, rgba(61, 80, 199, 0.15) 0%, transparent 70%); border-radius: 50%; transform: translate(50%, 50%); pointer-events: none;"></div>

        <!-- Заголовок графика -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; position: relative; z-index: 1;">
            <h3 style="color: #fff; font-size: 18px; font-weight: 700; margin: 0; text-shadow: 0 2px 10px rgba(90, 255, 117, 0.3);">
                {% trans "Динамика цены FL" %}
            </h3>
            <div id="chart-price-indicator" style="background: linear-gradient(135deg, rgba(90, 255, 117, 0.2) 0%, rgba(61, 80, 199, 0.2) 100%); color: #5AFF75; padding: 6px 14px; border-radius: 12px; font-size: 14px; font-weight: 700; border: 1px solid rgba(90, 255, 117, 0.3); box-shadow: 0 4px 15px rgba(90, 255, 117, 0.2);">
                {{ cf_price_rub }} ₽
            </div>
        </div>

        <!-- График -->
        <div id="candlestick-chart" style="width: 100%; height: 200px; max-width: 100%; position: relative; z-index: 1; border-radius: 12px; overflow: hidden;"></div>


        <div id="chart-loading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: rgba(255, 255, 255, 0.6); font-size: 14px; z-index: 0;">
            <div style="display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(90, 255, 117, 0.3); border-top-color: #5AFF75; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 10px; vertical-align: middle;"></div>
            {% trans "Загрузка графика..." %}
        </div>
    </div>
</div>

<style>
@keyframes spin {
    to { transform: rotate(360deg); }
}
.chart-wrapper {
    animation: fadeInUp 0.6s ease-out;
}
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>
{% if market_open %}
<!-- Кнопки -->
<div class="flex justify-center gap-6 mt-4">
    <button id="btn-buy" class="p2p-main-btn">{% trans "Купить" %}</button>
<button id="btn-sell" class="p2p-main-btn">{% trans "Продать" %}</button>

</div>




<div class="recent-trades-block mt-8 mb-4 ">

    <div style="background:rgba(34, 38, 82, 0.18); border-radius:13px; padding:13px 18px 7px 18px; margin-top: 10px;">
        {% for order in recent_trades %}
  <div class="flex items-center mb-1" style="color:#eaf2ff;">
    <span style="font-weight:500;">
      @{{ order.fulfilled_by.username|default:order.fulfilled_by.first_name|slice:":2" }}...
      {% trans "купил" %} {{ order.cf_amount|floatformat:0 }} FL
    </span>
  </div>
{% empty %}
  <div style="color:black; font-size:1rem;">{% trans "Пока никто не покупал FL" %}</div>
{% endfor %}

    </div>
</div>
{% else %}
      <div style="text-align:center; color:black; font-weight:600; margin:24px 0 24px 0; font-size:1.2rem">
    ⚠️ {% trans "Когда будут добыты все монеты, откроется п2п рынок" %}
  </div>
{% endif %}

<!-- Модалка Продать -->
<div id="modal-sell" class="p2p-modal">
  <div class="p2p-modal-content">
    <span class="p2p-modal-close" id="closeSellModal">&times;</span>
    <div class="p2p-modal-title">{% trans "Продать FL" %}</div>


    <form id="sell-form">
      <label class="p2p-modal-label">{% trans "Сколько FL хотите продать?" %}</label>
      <input id="cf-amount-input" name="cf_amount" type="number" min="0.01" step="0.01"
             class="p2p-modal-input" placeholder="{% trans 'Введите количество' %}">
      <div id="sell-convert-hint" class="p2p-modal-convert"></div>
      <button type="submit" class="p2p-modal-btn">{% trans "Продать" %}</button>
    </form>
    <div id="sell-result" class="p2p-modal-success"></div>
  </div>
</div>

<!-- Модалка Купить -->
<div id="modal-buy" class="p2p-modal">
  <div class="p2p-modal-content" style="max-width:440px;">
    <span class="p2p-modal-close" id="closeBuyModal">&times;</span>
    <div class="p2p-modal-title">{% trans "Ордера на продажу" %}</div>
      <div class="flex items-center gap-3 mb-4" id="buy-orders-filters" style="justify-content:center;">
    <label style="color:#fff; font-size:0.95em;">{% trans "Сортировка" %}:</label>
    <select id="order-sort-select" class="p2p-modal-input" style="width:auto; min-width:135px; padding:5px 18px;">
        <option value="price_asc">{% trans "Цена ↑" %}</option>
<option value="price_desc">{% trans "Цена ↓" %}</option>
<option value="amount_desc">{% trans "Кол-во ↓" %}</option>
<option value="amount_asc">{% trans "Кол-во ↑" %}</option>
<option value="all" selected>{% trans "Все" %}</option>

    </select>

</div>
    <div id="buy-orders-list">
      <div class="text-center text-gray-300 py-3" style="color:#c5d5fa;">{% trans "Загрузка..." %}</div>
    </div>
  </div>
</div>

<style>
.currency-btn{
  border: 1px solid rgba(255,255,255,.22);
  background: rgba(255,255,255,.08);
  color: #fff;
  font-weight: 700;
  border-radius: 999px;
  padding: 6px 12px;
  cursor: pointer;
  transition: transform .12s, background .12s, border-color .12s;
  line-height: 1;
}
.currency-btn:hover{ transform: scale(1.04); }
.currency-btn.active{
  background: linear-gradient(135deg, rgba(90,255,117,.22), rgba(61,80,199,.22));
  border-color: rgba(90,255,117,.40);
}
.p2p-main-btn {
    min-width: 155px;
    padding: 17px 0;
    border: none;
    border-radius: 999px;
    background: linear-gradient(180deg, #382686 2%, #5b43c9 97%);
    color: #fff;
    font-size: 1.17rem;
    font-weight: 500;
    box-shadow: 0 3px 22px #23286927;
    transition: background 0.14s, box-shadow 0.13s;
    outline: none;
    cursor: pointer;
    letter-spacing: 0.04em;
    margin-bottom: 0;
}
.p2p-main-btn:active, .p2p-main-btn:focus {
    background: linear-gradient(180deg, #281e5a 0%, #47319c 100%);
    box-shadow: 0 2px 8px #23286918;
}

.p2p-modal {
  display: none;
  position: fixed;
  z-index: 9999;
  left: 0;
  top: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(44, 50, 81, 0.48);
  justify-content: center;
  align-items: center;
}
.recent-trades-block { width: 100%; max-width: 520px; margin: 0 auto; }
.p2p-modal.active { display: flex; }
.p2p-modal-content {
  background: linear-gradient(90deg,#3a247a 10%, #368fff 100%);
  padding: 36px 28px 28px 28px;
  border-radius: 22px;
  box-shadow: 0 6px 28px #23286948;
  min-width: 275px; max-width: 96vw;
  position: relative;
  text-align: center;
}
.p2p-modal-close {
  position: absolute; right: 16px; top: 14px; font-size: 2rem; color: #aaa; cursor: pointer;
  font-weight: 700;
  transition: color 0.15s;
}
.p2p-modal-close:hover { color: #fff; }
.p2p-modal-title {
  font-size: 1.32rem;
  color: #fff;
  font-weight: 800;
  margin-bottom: 12px;
  letter-spacing: 0.03em;
}
.p2p-modal-label {
  color: #c8e0ff;
  font-size: 1rem;
  margin-bottom: 9px;
  display: block;
  font-weight: 500;
}
.p2p-modal-input {
  width: 100%;
  padding: 12px 15px;
  border-radius: 12px;
  border: 1.2px solid #5f74c9;
  font-size: 1.11rem;
  margin-bottom: 17px;
  color: #292866;
  font-weight: 700;
  background: #fff;
  outline: none;
  transition: border .15s;
}
.p2p-modal-input:focus { border-color: #368fff; }
.p2p-modal-convert {
  color: #f6fffa;
  font-size: 1.08rem;
  font-weight: 600;
  margin-bottom: 7px;
}
.p2p-modal-btn {
  width: 100%;
  padding: 13px 0;
  border: none;
  border-radius: 13px;
  background: linear-gradient(90deg,#3a247a 10%, #368fff 100%);
  color: #fff;
  font-size: 1.17rem;
  font-weight: 700;
  box-shadow: 0 2px 12px #3a247a22;
  margin-top: 8px;
  transition: background 0.13s;
  cursor: pointer;
}
#buy-orders-list {
    max-height: 450px; /* или сколько нужно — можно уменьшить для мобильных */
    overflow-y: auto;
    padding-right: 3px;
    margin-bottom: 7px;
}
@media (max-width: 600px) {
    #buy-orders-list {
        max-height: 450px;
    }
}

.p2p-modal-btn:active { background: linear-gradient(90deg,#4823b7 20%, #259aff 100%);}
.p2p-modal-success { color: #27be6c; font-weight: 700; margin-top: 8px;}
@media (max-width: 600px) {
  .p2p-modal-content { min-width: 85vw; padding: 22px 6vw 18px 6vw;}
}
</style>

    <div id="p2p-status-modal" class="p2p-modal">
  <div class="p2p-modal-content" style="max-width:360px;">
    <span class="p2p-modal-close" onclick="hideP2PStatusModal()">&times;</span>
    <div id="p2p-status-message" style="font-size:1.15rem; color:#fff; margin-bottom:12px;"></div>
    <button class="p2p-modal-btn" style="margin-top:5px;" onclick="hideP2PStatusModal()">OK</button>
  </div>
</div>


{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/lightweight-charts@4.0.1/dist/lightweight-charts.standalone.production.js"></script>
<script>
  window.I18N_P2P = {
    chart_loading: "{% trans 'Загрузка графика...' %}",
    chart_load_error: "{% trans 'Ошибка загрузки данных' %}",

    sell_loading: "{% trans 'Загрузка...' %}",
    rate_unavailable: "{% trans 'Курс временно недоступен' %}",

    rate_label: "{% trans 'Курс' %}",
    rate_fmt: "{% trans '1 FL = %(ton_per_cf)s TON, 1 TON = %(ton_to_rub)s ₽' %}",

    server_error: "{% trans 'Ошибка связи с сервером' %}",

    buy_order_confirm: "{% trans 'Купить этот ордер?' %}",

    // валюта
    currency_rate_missing: "{% trans 'Нет курса USD' %}",
  };
</script>

<script>
const p2pT = (window.I18N_P2P || {});
const tr = (key, fallback) => (p2pT[key] != null ? p2pT[key] : fallback);

let allCandles = []; // тут массив из API (history)
let visibleCount = 30; // сколько свечей видно одновременно
let chart, candleSeries, pointer = 0;

function showCandles() {
    let data = allCandles.slice(pointer, pointer + visibleCount);
    candleSeries.setData(data);
}
document.addEventListener('DOMContentLoaded', function() {
  // === БИРЖЕВОЙ ГРАФИК ===
  const chartContainer = document.getElementById('candlestick-chart');
  const chartLoading = document.getElementById('chart-loading');
  const containerWidth = chartContainer.offsetWidth || 320;

  fetch("{% url 'p2p:price_history_json' %}?v=" + Date.now())
      .then(r => r.json())
      .then(data => {
        // Скрываем индикатор загрузки
        if (chartLoading) {
          chartLoading.style.display = 'none';
        }

        const chart = LightweightCharts.createChart(chartContainer, {
          width: containerWidth,
          height: 200,
          layout: {
            background: { type: 'solid', color: 'transparent' },
            textColor: 'rgba(255, 255, 255, 0.85)',
            fontSize: 11,
            fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
          },
          grid: {
            vertLines: {
              color: 'rgba(255, 255, 255, 0.06)',
              style: 1,
              visible: true,
            },
            horzLines: {
              color: 'rgba(255, 255, 255, 0.06)',
              style: 1,
              visible: true,
            }
          },
          rightPriceScale: {
            visible: true,
            borderColor: 'rgba(255, 255, 255, 0.12)',
            scaleMargins: {
              top: 0.15,
              bottom: 0.15,
            },
            entireTextOnly: false,
            ticksVisible: true,
          },
          timeScale: {
            visible: true,
            borderColor: 'rgba(255, 255, 255, 0.12)',
            timeVisible: true,
            secondsVisible: false,
            rightOffset: 12,
            barSpacing: 3,
          },
          crosshair: {
            mode: 0,
            vertLine: {
              color: 'rgba(90, 255, 117, 0.6)',
              width: 1.5,
              style: 2,
              labelBackgroundColor: 'rgba(90, 255, 117, 0.9)',
            },
            horzLine: {
              color: 'rgba(90, 255, 117, 0.6)',
              width: 1.5,
              style: 2,
              labelBackgroundColor: 'rgba(90, 255, 117, 0.9)',
            },
          },
          handleScroll: {
            mouseWheel: true,
            pressedMouseMove: true,
          },
          handleScale: {
            axisPressedMouseMove: true,
            mouseWheel: true,
            pinch: true,
          },
        });

        const candleSeries = chart.addCandlestickSeries({
          upColor: '#5AFF75',
          downColor: '#FF5A8F',
          borderUpColor: '#5AFF75',
          borderDownColor: '#FF5A8F',
          wickUpColor: '#5AFF75',
          wickDownColor: '#FF5A8F',
          priceFormat: {
            type: 'price',
            precision: 2,
            minMove: 0.01,
          },
        });

        // Приводим данные к нужному формату:
        const candles = data.history.map(x => ({
          time: x.time,
          open: x.open,
          high: x.high,
          low: x.low,
          close: x.close,
        }));

        candleSeries.setData(candles);

        // Добавляем красную линию для падающих периодов (более заметная)


        // Вычисляем точки для красной линии (показываем все точки, но выделяем падения)
        const fallingPoints = [];
        for (let i = 0; i < candles.length; i++) {
          const candle = candles[i];
          // Если цена закрытия ниже цены открытия - это падение
          if (candle.close < candle.open) {
            fallingPoints.push({
              time: candle.time,
              value: candle.low, // показываем минимальную цену при падении
            });
          } else if (i > 0 && candles[i-1].close < candles[i-1].open) {
            // Если предыдущая свеча была падающей, соединяем линию
            fallingPoints.push({
              time: candle.time,
              value: candle.low,
            });
          }
        }

        // Если есть падающие точки, добавляем линию
        if (fallingPoints.length > 0) {
          fallingLineSeries.setData(fallingPoints);
        } else {
          // Если нет падающих свечей, показываем линию тренда вниз для визуализации
          const allLowPoints = candles.map(c => ({
            time: c.time,
            value: c.low,
          }));
          fallingLineSeries.setData(allLowPoints);
        }

        // Добавляем дополнительную красную пунктирную линию для визуализации падения


        // Вычисляем линию минимумов для визуализации падения
        const trendPoints = candles.map(c => ({
          time: c.time,
          value: c.low, // Показываем минимальные цены
        }));

        if (trendPoints.length > 0) {
          trendLineSeries.setData(trendPoints);
        }

        // Автоматическое масштабирование
        chart.timeScale().fitContent();

        // Обновление индикатора цены при наведении
        chart.subscribeCrosshairMove(param => {
          if (param.point === undefined || !param.time || param.point.x < 0 || param.point.x > containerWidth || param.point.y < 0 || param.point.y > 200) {
            return;
          }
          const data = param.seriesData.get(candleSeries);
          if (data && data.close !== undefined) {
            const priceIndicator = document.getElementById('chart-price-indicator');
            if (priceIndicator) {
              priceIndicator.textContent = data.close.toFixed(2) + ' ₽';
              priceIndicator.style.transform = 'scale(1.05)';
              setTimeout(() => {
                priceIndicator.style.transform = 'scale(1)';
              }, 150);
            }
          }
        });

        // Обработка изменения размера окна
        let resizeTimeout;
        window.addEventListener('resize', () => {
          clearTimeout(resizeTimeout);
          resizeTimeout = setTimeout(() => {
            const newWidth = chartContainer.offsetWidth;
            if (newWidth > 0) {
              chart.applyOptions({ width: newWidth });
            }
          }, 150);
        });
      })
      .catch(error => {
        console.error('Ошибка загрузки графика:', error);
        if (chartLoading) {
          chartLoading.innerHTML = '<span style="color: #FF5A8F;">' + tr('chart_load_error', 'Ошибка загрузки данных') + '</span>';

        }
      });

  // === ОБРАБОТКА КНОПОК, ФОРМ, МОДАЛОК ===

  // Глобальные переменные (из шаблона)
  window.tonPerCf = Number('{{ ton_per_cf|default:0|safe }}');
  window.tonToRub = Number('{{ ton_to_rub|default:0|safe }}');
  window.cfPriceRub = Number('{{ cf_price_rub|default:0|safe }}');
  // ================== ВАЛЮТА (₽ / $) ==================
window.fxRates = {
  RUB: 1,
  USD: Number('{{ usd_to_rub|default:0|safe }}') // сколько ₽ за 1$
};
// Если usd_to_rub не передали с бэка — можно будет подтянуть через API позже
window.selectedCurrency = localStorage.getItem('p2p_currency') || 'RUB';

function formatMoney(v, currency) {
  if (v === null || v === undefined || isNaN(v)) return '—';
  const digits = (currency === 'RUB') ? 2 : 2;
  return Number(v).toFixed(digits);
}

function convertFromRub(rubValue, currency) {
  if (currency === 'RUB') return rubValue;
  const usdToRub = window.fxRates.USD;
  if (!usdToRub || usdToRub <= 0) return null; // нет курса
  return rubValue / usdToRub;
}

function renderRates() {
  const cur = window.selectedCurrency;

  // FL price
  const cfVal = document.getElementById('cf-price-value');
  const cfCur = document.getElementById('cf-price-currency');

  // TON price
  const tonVal = document.getElementById('ton-price-value');
  const tonCur = document.getElementById('ton-price-currency');

  // Индикатор сверху графика (у тебя он сейчас в ₽)
  const chartIndicator = document.getElementById('chart-price-indicator');

  // исходные значения в ₽
  const cfRub = window.cfPriceRub;
  const tonRub = window.tonToRub;

  const cfOut = convertFromRub(cfRub, cur);
  const tonOut = convertFromRub(tonRub, cur);

  if (cfVal) cfVal.textContent = (cfOut === null ? '—' : formatMoney(cfOut, cur));
  if (tonVal) tonVal.textContent = (tonOut === null ? '—' : formatMoney(tonOut, cur));

  const sym = (cur === 'RUB') ? '₽' : '$';
  if (cfCur) cfCur.textContent = sym;
  if (tonCur) tonCur.textContent = sym;

  // обновим индикатор цены на графике текущей свечи (если хочешь — только для стартовой цены)
  if (chartIndicator) {
    const base = cfRub; // это текущая цена FL в ₽ из бекенда
    const out = convertFromRub(base, cur);
    chartIndicator.textContent = (out === null ? '—' : formatMoney(out, cur)) + ' ' + sym;
  }

  // подсветка кнопок
  document.querySelectorAll('.currency-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.currency === cur);
  });
}

document.querySelectorAll('.currency-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    window.selectedCurrency = btn.dataset.currency;
    localStorage.setItem('p2p_currency', window.selectedCurrency);
    renderRates();
  });
});

// первичный рендер
renderRates();


  // --- ПРОДАТЬ ---
  const btnSell = document.getElementById('btn-sell');
  const btnBuy = document.getElementById('btn-buy');
  const closeSellModal = document.getElementById('closeSellModal');
  const closeBuyModal = document.getElementById('closeBuyModal');
  const sellForm = document.getElementById('sell-form');
  const cfAmountInput = document.getElementById('cf-amount-input');
  const sellConvertHint = document.getElementById('sell-convert-hint');
  const sellResult = document.getElementById('sell-result');

  if (btnSell) btnSell.onclick = function() {
      document.getElementById('modal-sell').classList.add('active');
      document.body.style.overflow = 'hidden';
  };
  if (closeSellModal) closeSellModal.onclick = function() {
      document.getElementById('modal-sell').classList.remove('active');
      document.body.style.overflow = '';
      if (sellForm) sellForm.reset();
      if (sellResult) sellResult.innerText = '';
      if (sellConvertHint) sellConvertHint.innerText = '';
  };
  if (cfAmountInput) cfAmountInput.oninput = function () {
  let cf = parseFloat(this.value) || 0;

  if (window.tonPerCf && window.tonToRub) {
    let ton = (cf * window.tonPerCf).toFixed(3);
    let tonPerCf = Number(window.tonPerCf).toFixed(3);
    let tonToRub = Number(window.tonToRub).toFixed(2);

    const rateLabel = tr('rate_label', 'Курс');
    let rateFmt = tr('rate_fmt', '1 FL = %(ton_per_cf)s TON, 1 TON = %(ton_to_rub)s ₽');

    // подстановка %(...)s
    rateFmt = rateFmt
      .replace('%(ton_per_cf)s', `<b>${tonPerCf}</b>`)
      .replace('%(ton_to_rub)s', `<b>${tonToRub}</b>`);

    sellConvertHint.innerHTML = cf
      ? `<span style="color:#fff;">${cf} FL ≈ <b>${ton} TON</b></span>
         <br><span style="font-size:14px;color:#bed7fa;">${rateLabel}: ${rateFmt}</span>`
      : '';
  } else {
    sellConvertHint.innerHTML =
      `<span style="color:#e85;">${tr('rate_unavailable', 'Курс временно недоступен')}</span>`;
  }
};

  if (sellForm) sellForm.onsubmit = function(e){
      e.preventDefault();
      const cf = parseFloat(cfAmountInput.value) || 0;
      if (cf <= 0) return;
      sellResult.innerText = tr('sell_loading', 'Загрузка...');

      fetch("{% url 'p2p:sell_order' %}", {
          method: "POST",
          headers: {
              "Content-Type": "application/x-www-form-urlencoded",
              "X-CSRFToken": "{{ csrf_token }}"
          },
          body: "cf_amount=" + encodeURIComponent(cf)
      })
      .then(r => r.json())
      .then(data => {
          showP2PStatusModal(data.msg, !!data.success);
          if (data.success) {
              setTimeout(() => {
                  document.getElementById('modal-sell').classList.remove('active');
                  document.body.style.overflow = '';
                  sellForm.reset();
                  sellResult.innerText = '';
                  sellConvertHint.innerText = '';
                  updateBuyOrders();
              }, 1300);
          } else {
              sellResult.innerText = data.msg;
          }
      })
      .catch(() => {
          showP2PStatusModal(tr('server_error', 'Ошибка связи с сервером'), false);
      });
  };

  // --- КУПИТЬ ---
  if (btnBuy) btnBuy.onclick = function() {
      document.getElementById('modal-buy').classList.add('active');
      document.body.style.overflow = 'hidden';
      updateBuyOrders();
  };
  if (closeBuyModal) closeBuyModal.onclick = function() {
      document.getElementById('modal-buy').classList.remove('active');
      document.body.style.overflow = '';
  };

  // --- ФИЛЬТРЫ ---
  let currentSort = "all";
  let currentMinAmount = "";
  function attachBuyOrderHandlers() {
      document.querySelectorAll('.btn-buy-order').forEach(btn => {
          btn.onclick = function() {
              const orderId = this.dataset.orderId;
              window.buyOrder(orderId);
          };
      });
  }
  function updateBuyOrders() {
      const params = new URLSearchParams();
      if (currentSort && currentSort !== "all") params.append("sort", currentSort);
      if (currentMinAmount) params.append("min_amount", currentMinAmount);

      fetch("{% url 'p2p:buy_ajax' %}?" + params.toString())
          .then(r => r.text())
          .then(html => {
              document.getElementById('buy-orders-list').innerHTML = html;
              attachBuyOrderHandlers();
          });
  }
  attachBuyOrderHandlers();

  const orderSortSelect = document.getElementById('order-sort-select');
  if (orderSortSelect) orderSortSelect.onchange = function() {
      currentSort = this.value;
      updateBuyOrders();
  };

  // --- МОДАЛКИ И СТАТУСЫ ---
  window.showP2PStatusModal = function(message, isSuccess=true, callback=null) {
      const modal = document.getElementById('p2p-status-modal');
      const msg = document.getElementById('p2p-status-message');
      msg.innerHTML = message;
      msg.style.color = isSuccess ? '#27be6c' : '#ff6868';
      modal.classList.add('active');
      document.body.style.overflow = 'hidden';

      const okBtn = modal.querySelector('.p2p-modal-btn');
      okBtn.onclick = function() {
          modal.classList.remove('active');
          document.body.style.overflow = '';
          if (callback) callback();
      };
  };
  window.hideP2PStatusModal = function() {
      document.getElementById('p2p-status-modal').classList.remove('active');
      document.body.style.overflow = '';
  };

  window.buyOrder = function(orderId) {
      if (!orderId) return;
      showP2PStatusModal(tr('buy_order_confirm', 'Купить этот ордер?'), true, function(){
  doBuyOrder(orderId);
});
  };

  function doBuyOrder(orderId) {
      fetch("{% url 'p2p:buy_order' %}", {
          method: "POST",
          headers: {
              "Content-Type": "application/x-www-form-urlencoded",
              "X-CSRFToken": "{{ csrf_token }}"
          },
          body: "order_id=" + encodeURIComponent(orderId)
      })
      .then(r => r.json())
      .then(data => {
          showP2PStatusModal(data.msg, !!data.success, function() {
              if (data.success) {
                  updateBuyOrders();
                  document.getElementById('modal-buy').classList.remove('active');
                  document.body.style.overflow = '';
                  location.reload();
              }
          });
      })
      .catch(() => {
          showP2PStatusModal("Ошибка связи с сервером", false);
      });
  }
});

</script>


{% endblock %}
