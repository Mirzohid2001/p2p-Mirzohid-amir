{% extends "base.html" %}
{% load humanize %}

{% block title %}P2P –ë–∏—Ä–∂–∞ FL{% endblock %}

{% block content %}
<div class="cf-summary-block mb-4 animate-float">
    <div>–°–æ–∑–¥–∞–Ω–æ FL: {{ cf_created|intcomma }}</div>
    <div>–í—ã—Ä–∞—â–µ–Ω–æ: {{ cf_grown|floatformat:0|intcomma }}</div>
    <div>–û—Å—Ç–∞–ª–æ—Å—å: {{ cf_left|floatformat:0|intcomma }}</div>
</div>

<!-- –¶–µ–Ω–∞ TON –∏ CF -->
<div class="flex justify-center gap-6 mt-2 mb-4 text-white text-base">
    <div>–¶–µ–Ω–∞ FL: <span class="font-bold">{{ cf_price_rub }}</span> ‚ÇΩ</div>
    <div>TON: <span class="font-bold">{% if ton_to_rub %}{{ ton_to_rub|floatformat:2 }}{% else %}‚Äî{% endif %}</span> ‚ÇΩ</div>
</div>

<!-- –ì—Ä–∞—Ñ–∏–∫ -->
<div class="chart-wrapper mb-4" style="position: relative; overflow: hidden;">
    <div class="chart-container" style="background: linear-gradient(135deg, rgba(90, 140, 255, 0.12) 0%, rgba(61, 80, 199, 0.15) 50%, rgba(90, 255, 117, 0.08) 100%); border-radius: 24px; border: 1px solid rgba(255, 255, 255, 0.15); box-shadow: 0 12px 40px rgba(0, 0, 0, 0.25), inset 0 0 60px rgba(90, 140, 255, 0.1); min-height: 240px; backdrop-filter: blur(15px); position: relative; padding: 20px;">
        <!-- –î–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã -->
        <div style="position: absolute; top: 0; left: 0; width: 200px; height: 200px; background: radial-gradient(circle, rgba(90, 255, 117, 0.1) 0%, transparent 70%); border-radius: 50%; transform: translate(-50%, -50%); pointer-events: none;"></div>
        <div style="position: absolute; bottom: 0; right: 0; width: 150px; height: 150px; background: radial-gradient(circle, rgba(61, 80, 199, 0.15) 0%, transparent 70%); border-radius: 50%; transform: translate(50%, 50%); pointer-events: none;"></div>

        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –≥—Ä–∞—Ñ–∏–∫–∞ -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; position: relative; z-index: 1;">
            <h3 style="color: #fff; font-size: 18px; font-weight: 700; margin: 0; text-shadow: 0 2px 10px rgba(90, 255, 117, 0.3);">
                üìà –î–∏–Ω–∞–º–∏–∫–∞ —Ü–µ–Ω—ã FL
            </h3>
            <div id="chart-price-indicator" style="background: linear-gradient(135deg, rgba(90, 255, 117, 0.2) 0%, rgba(61, 80, 199, 0.2) 100%); color: #5AFF75; padding: 6px 14px; border-radius: 12px; font-size: 14px; font-weight: 700; border: 1px solid rgba(90, 255, 117, 0.3); box-shadow: 0 4px 15px rgba(90, 255, 117, 0.2);">
                {{ cf_price_rub }} ‚ÇΩ
            </div>
        </div>

        <!-- –ì—Ä–∞—Ñ–∏–∫ -->
        <div id="candlestick-chart" style="width: 100%; height: 200px; max-width: 100%; position: relative; z-index: 1; border-radius: 12px; overflow: hidden;"></div>

        <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
        <div id="chart-loading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: rgba(255, 255, 255, 0.6); font-size: 14px; z-index: 0;">
            <div style="display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(90, 255, 117, 0.3); border-top-color: #5AFF75; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 10px; vertical-align: middle;"></div>
            –ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∞...
        </div>
    </div>
</div>

<style>
@keyframes spin {
    to { transform: rotate(360deg); }
}
.chart-wrapper {
    animation: fadeInUp 0.6s ease-out;
}
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>
{% if market_open %}
<!-- –ö–Ω–æ–ø–∫–∏ -->
<div class="flex justify-center gap-6 mt-4">
    <button id="btn-buy" class="p2p-main-btn">–ö—É–ø–∏—Ç—å</button>
    <button id="btn-sell" class="p2p-main-btn">–ü—Ä–æ–¥–∞—Ç—å</button>
</div>




<div class="recent-trades-block mt-8 mb-4 ">

    <div style="background:rgba(34, 38, 82, 0.18); border-radius:13px; padding:13px 18px 7px 18px; margin-top: 10px;">
        {% for order in recent_trades %}
  <div class="flex items-center mb-1" style="color:#eaf2ff;">
    <span style="font-weight:500;">
      @{{ order.fulfilled_by.username|default:order.fulfilled_by.first_name|slice:":2" }}... –∫—É–ø–∏–ª
      {{ order.cf_amount|floatformat:0 }} FL
    </span>
  </div>
{% empty %}
  <div style="color:#b3b9dc; font-size:1rem;">–ü–æ–∫–∞ –Ω–∏–∫—Ç–æ –Ω–µ –ø–æ–∫—É–ø–∞–ª FL</div>
{% endfor %}

    </div>
</div>
{% else %}
      <div style="text-align:center; color:#ffeaa7; font-weight:600; margin:24px 0 24px 0; font-size:1.2rem">
    ‚ö†Ô∏è –ö–æ–≥–¥–∞ –±—É–¥—É—Ç –¥–æ–±—ã—Ç—ã –≤—Å–µ –º–æ–Ω–µ—Ç—ã, –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –ø2–ø —Ä—ã–Ω–æ–∫
  </div>
{% endif %}

<!-- –ú–æ–¥–∞–ª–∫–∞ –ü—Ä–æ–¥–∞—Ç—å -->
<div id="modal-sell" class="p2p-modal">
  <div class="p2p-modal-content">
    <span class="p2p-modal-close" id="closeSellModal">&times;</span>
    <div class="p2p-modal-title">–ü—Ä–æ–¥–∞—Ç—å FL</div>


    <form id="sell-form">
      <label class="p2p-modal-label">–°–∫–æ–ª—å–∫–æ FL —Ö–æ—Ç–∏—Ç–µ –ø—Ä–æ–¥–∞—Ç—å?</label>
      <input id="cf-amount-input" name="cf_amount" type="number" min="0.01" step="0.01"
             class="p2p-modal-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ">
      <div id="sell-convert-hint" class="p2p-modal-convert"></div>
      <button type="submit" class="p2p-modal-btn">–ü—Ä–æ–¥–∞—Ç—å</button>
    </form>
    <div id="sell-result" class="p2p-modal-success"></div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ –ö—É–ø–∏—Ç—å -->
<div id="modal-buy" class="p2p-modal">
  <div class="p2p-modal-content" style="max-width:440px;">
    <span class="p2p-modal-close" id="closeBuyModal">&times;</span>
    <div class="p2p-modal-title">–û—Ä–¥–µ—Ä–∞ –Ω–∞ –ø—Ä–æ–¥–∞–∂—É</div>
      <div class="flex items-center gap-3 mb-4" id="buy-orders-filters" style="justify-content:center;">
    <label style="color:#fff; font-size:0.95em;">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:</label>
    <select id="order-sort-select" class="p2p-modal-input" style="width:auto; min-width:135px; padding:5px 18px;">
        <option value="price_asc">–¶–µ–Ω–∞ ‚Üë</option>
        <option value="price_desc">–¶–µ–Ω–∞ ‚Üì</option>
        <option value="amount_desc">–ö–æ–ª-–≤–æ ‚Üì</option>
        <option value="amount_asc">–ö–æ–ª-–≤–æ ‚Üë</option>
        <option value="all" selected>–í—Å–µ</option>
    </select>

</div>
    <div id="buy-orders-list">
      <div class="text-center text-gray-300 py-3" style="color:#c5d5fa;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>
  </div>
</div>

<style>
.p2p-main-btn {
    min-width: 155px;
    padding: 17px 0;
    border: none;
    border-radius: 999px;
    background: linear-gradient(180deg, #382686 2%, #5b43c9 97%);
    color: #fff;
    font-size: 1.17rem;
    font-weight: 500;
    box-shadow: 0 3px 22px #23286927;
    transition: background 0.14s, box-shadow 0.13s;
    outline: none;
    cursor: pointer;
    letter-spacing: 0.04em;
    margin-bottom: 0;
}
.p2p-main-btn:active, .p2p-main-btn:focus {
    background: linear-gradient(180deg, #281e5a 0%, #47319c 100%);
    box-shadow: 0 2px 8px #23286918;
}

.p2p-modal {
  display: none;
  position: fixed;
  z-index: 9999;
  left: 0;
  top: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(44, 50, 81, 0.48);
  justify-content: center;
  align-items: center;
}
.recent-trades-block { width: 100%; max-width: 520px; margin: 0 auto; }
.p2p-modal.active { display: flex; }
.p2p-modal-content {
  background: linear-gradient(90deg,#3a247a 10%, #368fff 100%);
  padding: 36px 28px 28px 28px;
  border-radius: 22px;
  box-shadow: 0 6px 28px #23286948;
  min-width: 275px; max-width: 96vw;
  position: relative;
  text-align: center;
}
.p2p-modal-close {
  position: absolute; right: 16px; top: 14px; font-size: 2rem; color: #aaa; cursor: pointer;
  font-weight: 700;
  transition: color 0.15s;
}
.p2p-modal-close:hover { color: #fff; }
.p2p-modal-title {
  font-size: 1.32rem;
  color: #fff;
  font-weight: 800;
  margin-bottom: 12px;
  letter-spacing: 0.03em;
}
.p2p-modal-label {
  color: #c8e0ff;
  font-size: 1rem;
  margin-bottom: 9px;
  display: block;
  font-weight: 500;
}
.p2p-modal-input {
  width: 100%;
  padding: 12px 15px;
  border-radius: 12px;
  border: 1.2px solid #5f74c9;
  font-size: 1.11rem;
  margin-bottom: 17px;
  color: #292866;
  font-weight: 700;
  background: #fff;
  outline: none;
  transition: border .15s;
}
.p2p-modal-input:focus { border-color: #368fff; }
.p2p-modal-convert {
  color: #f6fffa;
  font-size: 1.08rem;
  font-weight: 600;
  margin-bottom: 7px;
}
.p2p-modal-btn {
  width: 100%;
  padding: 13px 0;
  border: none;
  border-radius: 13px;
  background: linear-gradient(90deg,#3a247a 10%, #368fff 100%);
  color: #fff;
  font-size: 1.17rem;
  font-weight: 700;
  box-shadow: 0 2px 12px #3a247a22;
  margin-top: 8px;
  transition: background 0.13s;
  cursor: pointer;
}
#buy-orders-list {
    max-height: 450px; /* –∏–ª–∏ —Å–∫–æ–ª—å–∫–æ –Ω—É–∂–Ω–æ ‚Äî –º–æ–∂–Ω–æ —É–º–µ–Ω—å—à–∏—Ç—å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
    overflow-y: auto;
    padding-right: 3px;
    margin-bottom: 7px;
}
@media (max-width: 600px) {
    #buy-orders-list {
        max-height: 450px;
    }
}

.p2p-modal-btn:active { background: linear-gradient(90deg,#4823b7 20%, #259aff 100%);}
.p2p-modal-success { color: #27be6c; font-weight: 700; margin-top: 8px;}
@media (max-width: 600px) {
  .p2p-modal-content { min-width: 85vw; padding: 22px 6vw 18px 6vw;}
}
</style>

    <div id="p2p-status-modal" class="p2p-modal">
  <div class="p2p-modal-content" style="max-width:360px;">
    <span class="p2p-modal-close" onclick="hideP2PStatusModal()">&times;</span>
    <div id="p2p-status-message" style="font-size:1.15rem; color:#fff; margin-bottom:12px;"></div>
    <button class="p2p-modal-btn" style="margin-top:5px;" onclick="hideP2PStatusModal()">OK</button>
  </div>
</div>


{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/lightweight-charts@4.0.1/dist/lightweight-charts.standalone.production.js"></script>

<script>
let allCandles = []; // —Ç—É—Ç –º–∞—Å—Å–∏–≤ –∏–∑ API (history)
let visibleCount = 30; // —Å–∫–æ–ª—å–∫–æ —Å–≤–µ—á–µ–π –≤–∏–¥–Ω–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
let chart, candleSeries, pointer = 0;

function showCandles() {
    let data = allCandles.slice(pointer, pointer + visibleCount);
    candleSeries.setData(data);
}
document.addEventListener('DOMContentLoaded', function() {
  // === –ë–ò–†–ñ–ï–í–û–ô –ì–†–ê–§–ò–ö ===
  const chartContainer = document.getElementById('candlestick-chart');
  const chartLoading = document.getElementById('chart-loading');
  const containerWidth = chartContainer.offsetWidth || 320;

  fetch("{% url 'p2p:price_history_json' %}?v=" + Date.now())
      .then(r => r.json())
      .then(data => {
        // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        if (chartLoading) {
          chartLoading.style.display = 'none';
        }

        const chart = LightweightCharts.createChart(chartContainer, {
          width: containerWidth,
          height: 200,
          layout: {
            background: { type: 'solid', color: 'transparent' },
            textColor: 'rgba(255, 255, 255, 0.85)',
            fontSize: 11,
            fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
          },
          grid: {
            vertLines: {
              color: 'rgba(255, 255, 255, 0.06)',
              style: 1,
              visible: true,
            },
            horzLines: {
              color: 'rgba(255, 255, 255, 0.06)',
              style: 1,
              visible: true,
            }
          },
          rightPriceScale: {
            visible: true,
            borderColor: 'rgba(255, 255, 255, 0.12)',
            scaleMargins: {
              top: 0.15,
              bottom: 0.15,
            },
            entireTextOnly: false,
            ticksVisible: true,
          },
          timeScale: {
            visible: true,
            borderColor: 'rgba(255, 255, 255, 0.12)',
            timeVisible: true,
            secondsVisible: false,
            rightOffset: 12,
            barSpacing: 3,
          },
          crosshair: {
            mode: 0,
            vertLine: {
              color: 'rgba(90, 255, 117, 0.6)',
              width: 1.5,
              style: 2,
              labelBackgroundColor: 'rgba(90, 255, 117, 0.9)',
            },
            horzLine: {
              color: 'rgba(90, 255, 117, 0.6)',
              width: 1.5,
              style: 2,
              labelBackgroundColor: 'rgba(90, 255, 117, 0.9)',
            },
          },
          handleScroll: {
            mouseWheel: true,
            pressedMouseMove: true,
          },
          handleScale: {
            axisPressedMouseMove: true,
            mouseWheel: true,
            pinch: true,
          },
        });

        const candleSeries = chart.addCandlestickSeries({
          upColor: '#5AFF75',
          downColor: '#FF5A8F',
          borderUpColor: '#5AFF75',
          borderDownColor: '#FF5A8F',
          wickUpColor: '#5AFF75',
          wickDownColor: '#FF5A8F',
          priceFormat: {
            type: 'price',
            precision: 2,
            minMove: 0.01,
          },
        });

        // –ü—Ä–∏–≤–æ–¥–∏–º –¥–∞–Ω–Ω—ã–µ –∫ –Ω—É–∂–Ω–æ–º—É —Ñ–æ—Ä–º–∞—Ç—É:
        const candles = data.history.map(x => ({
          time: x.time,
          open: x.open,
          high: x.high,
          low: x.low,
          close: x.close,
        }));

        candleSeries.setData(candles);

        // –î–æ–±–∞–≤–ª—è–µ–º –∫—Ä–∞—Å–Ω—É—é –ª–∏–Ω–∏—é –¥–ª—è –ø–∞–¥–∞—é—â–∏—Ö –ø–µ—Ä–∏–æ–¥–æ–≤ (–±–æ–ª–µ–µ –∑–∞–º–µ—Ç–Ω–∞—è)


        // –í—ã—á–∏—Å–ª—è–µ–º —Ç–æ—á–∫–∏ –¥–ª—è –∫—Ä–∞—Å–Ω–æ–π –ª–∏–Ω–∏–∏ (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ —Ç–æ—á–∫–∏, –Ω–æ –≤—ã–¥–µ–ª—è–µ–º –ø–∞–¥–µ–Ω–∏—è)
        const fallingPoints = [];
        for (let i = 0; i < candles.length; i++) {
          const candle = candles[i];
          // –ï—Å–ª–∏ —Ü–µ–Ω–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –Ω–∏–∂–µ —Ü–µ–Ω—ã –æ—Ç–∫—Ä—ã—Ç–∏—è - —ç—Ç–æ –ø–∞–¥–µ–Ω–∏–µ
          if (candle.close < candle.open) {
            fallingPoints.push({
              time: candle.time,
              value: candle.low, // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏
            });
          } else if (i > 0 && candles[i-1].close < candles[i-1].open) {
            // –ï—Å–ª–∏ –ø—Ä–µ–¥—ã–¥—É—â–∞—è —Å–≤–µ—á–∞ –±—ã–ª–∞ –ø–∞–¥–∞—é—â–µ–π, —Å–æ–µ–¥–∏–Ω—è–µ–º –ª–∏–Ω–∏—é
            fallingPoints.push({
              time: candle.time,
              value: candle.low,
            });
          }
        }

        // –ï—Å–ª–∏ –µ—Å—Ç—å –ø–∞–¥–∞—é—â–∏–µ —Ç–æ—á–∫–∏, –¥–æ–±–∞–≤–ª—è–µ–º –ª–∏–Ω–∏—é
        if (fallingPoints.length > 0) {
          fallingLineSeries.setData(fallingPoints);
        } else {
          // –ï—Å–ª–∏ –Ω–µ—Ç –ø–∞–¥–∞—é—â–∏—Ö —Å–≤–µ—á–µ–π, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–∏–Ω–∏—é —Ç—Ä–µ–Ω–¥–∞ –≤–Ω–∏–∑ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
          const allLowPoints = candles.map(c => ({
            time: c.time,
            value: c.low,
          }));
          fallingLineSeries.setData(allLowPoints);
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∫—Ä–∞—Å–Ω—É—é –ø—É–Ω–∫—Ç–∏—Ä–Ω—É—é –ª–∏–Ω–∏—é –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–∞–¥–µ–Ω–∏—è


        // –í—ã—á–∏—Å–ª—è–µ–º –ª–∏–Ω–∏—é –º–∏–Ω–∏–º—É–º–æ–≤ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–∞–¥–µ–Ω–∏—è
        const trendPoints = candles.map(c => ({
          time: c.time,
          value: c.low, // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Ü–µ–Ω—ã
        }));

        if (trendPoints.length > 0) {
          trendLineSeries.setData(trendPoints);
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
        chart.timeScale().fitContent();

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ —Ü–µ–Ω—ã –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
        chart.subscribeCrosshairMove(param => {
          if (param.point === undefined || !param.time || param.point.x < 0 || param.point.x > containerWidth || param.point.y < 0 || param.point.y > 200) {
            return;
          }
          const data = param.seriesData.get(candleSeries);
          if (data && data.close !== undefined) {
            const priceIndicator = document.getElementById('chart-price-indicator');
            if (priceIndicator) {
              priceIndicator.textContent = data.close.toFixed(2) + ' ‚ÇΩ';
              priceIndicator.style.transform = 'scale(1.05)';
              setTimeout(() => {
                priceIndicator.style.transform = 'scale(1)';
              }, 150);
            }
          }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
        let resizeTimeout;
        window.addEventListener('resize', () => {
          clearTimeout(resizeTimeout);
          resizeTimeout = setTimeout(() => {
            const newWidth = chartContainer.offsetWidth;
            if (newWidth > 0) {
              chart.applyOptions({ width: newWidth });
            }
          }, 150);
        });
      })
      .catch(error => {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞:', error);
        if (chartLoading) {
          chartLoading.innerHTML = '<span style="color: #FF5A8F;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</span>';
        }
      });

  // === –û–ë–†–ê–ë–û–¢–ö–ê –ö–ù–û–ü–û–ö, –§–û–†–ú, –ú–û–î–ê–õ–û–ö ===

  // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (–∏–∑ —à–∞–±–ª–æ–Ω–∞)
  window.tonPerCf = Number('{{ ton_per_cf|default:0|safe }}');
  window.tonToRub = Number('{{ ton_to_rub|default:0|safe }}');
  window.cfPriceRub = Number('{{ cf_price_rub|default:0|safe }}');

  // --- –ü–†–û–î–ê–¢–¨ ---
  const btnSell = document.getElementById('btn-sell');
  const btnBuy = document.getElementById('btn-buy');
  const closeSellModal = document.getElementById('closeSellModal');
  const closeBuyModal = document.getElementById('closeBuyModal');
  const sellForm = document.getElementById('sell-form');
  const cfAmountInput = document.getElementById('cf-amount-input');
  const sellConvertHint = document.getElementById('sell-convert-hint');
  const sellResult = document.getElementById('sell-result');

  if (btnSell) btnSell.onclick = function() {
      document.getElementById('modal-sell').classList.add('active');
      document.body.style.overflow = 'hidden';
  };
  if (closeSellModal) closeSellModal.onclick = function() {
      document.getElementById('modal-sell').classList.remove('active');
      document.body.style.overflow = '';
      if (sellForm) sellForm.reset();
      if (sellResult) sellResult.innerText = '';
      if (sellConvertHint) sellConvertHint.innerText = '';
  };
  if (cfAmountInput) cfAmountInput.oninput = function() {
    let cf = parseFloat(this.value) || 0;
    if (window.tonPerCf && window.tonToRub) {
      let ton = (cf * window.tonPerCf).toFixed(3);
      let tonPerCf = Number(window.tonPerCf).toFixed(3);
      let tonToRub = Number(window.tonToRub).toFixed(2);
      sellConvertHint.innerHTML = cf ?
        `<span style="color:#fff;">${cf} FL ‚âà <b>${ton} TON</b></span>
        <br><span style="font-size:14px;color:#bed7fa;">–ö—É—Ä—Å: 1 FL = <b>${tonPerCf}</b> TON, 1 TON = <b>${tonToRub}</b> ‚ÇΩ</span>`
        : '';
    } else {
      sellConvertHint.innerHTML = `<span style="color:#e85;">–ö—É—Ä—Å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</span>`;
    }
  };
  if (sellForm) sellForm.onsubmit = function(e){
      e.preventDefault();
      const cf = parseFloat(cfAmountInput.value) || 0;
      if (cf <= 0) return;
      sellResult.innerText = "–ó–∞–≥—Ä—É–∑–∫–∞...";
      fetch("{% url 'p2p:sell_order' %}", {
          method: "POST",
          headers: {
              "Content-Type": "application/x-www-form-urlencoded",
              "X-CSRFToken": "{{ csrf_token }}"
          },
          body: "cf_amount=" + encodeURIComponent(cf)
      })
      .then(r => r.json())
      .then(data => {
          showP2PStatusModal(data.msg, !!data.success);
          if (data.success) {
              setTimeout(() => {
                  document.getElementById('modal-sell').classList.remove('active');
                  document.body.style.overflow = '';
                  sellForm.reset();
                  sellResult.innerText = '';
                  sellConvertHint.innerText = '';
                  updateBuyOrders();
              }, 1300);
          } else {
              sellResult.innerText = data.msg;
          }
      })
      .catch(() => {
          showP2PStatusModal("–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º", false);
      });
  };

  // --- –ö–£–ü–ò–¢–¨ ---
  if (btnBuy) btnBuy.onclick = function() {
      document.getElementById('modal-buy').classList.add('active');
      document.body.style.overflow = 'hidden';
      updateBuyOrders();
  };
  if (closeBuyModal) closeBuyModal.onclick = function() {
      document.getElementById('modal-buy').classList.remove('active');
      document.body.style.overflow = '';
  };

  // --- –§–ò–õ–¨–¢–†–´ ---
  let currentSort = "all";
  let currentMinAmount = "";
  function attachBuyOrderHandlers() {
      document.querySelectorAll('.btn-buy-order').forEach(btn => {
          btn.onclick = function() {
              const orderId = this.dataset.orderId;
              window.buyOrder(orderId);
          };
      });
  }
  function updateBuyOrders() {
      const params = new URLSearchParams();
      if (currentSort && currentSort !== "all") params.append("sort", currentSort);
      if (currentMinAmount) params.append("min_amount", currentMinAmount);

      fetch("{% url 'p2p:buy_ajax' %}?" + params.toString())
          .then(r => r.text())
          .then(html => {
              document.getElementById('buy-orders-list').innerHTML = html;
              attachBuyOrderHandlers();
          });
  }
  attachBuyOrderHandlers();

  const orderSortSelect = document.getElementById('order-sort-select');
  if (orderSortSelect) orderSortSelect.onchange = function() {
      currentSort = this.value;
      updateBuyOrders();
  };

  // --- –ú–û–î–ê–õ–ö–ò –ò –°–¢–ê–¢–£–°–´ ---
  window.showP2PStatusModal = function(message, isSuccess=true, callback=null) {
      const modal = document.getElementById('p2p-status-modal');
      const msg = document.getElementById('p2p-status-message');
      msg.innerHTML = message;
      msg.style.color = isSuccess ? '#27be6c' : '#ff6868';
      modal.classList.add('active');
      document.body.style.overflow = 'hidden';

      const okBtn = modal.querySelector('.p2p-modal-btn');
      okBtn.onclick = function() {
          modal.classList.remove('active');
          document.body.style.overflow = '';
          if (callback) callback();
      };
  };
  window.hideP2PStatusModal = function() {
      document.getElementById('p2p-status-modal').classList.remove('active');
      document.body.style.overflow = '';
  };

  window.buyOrder = function(orderId) {
      if (!orderId) return;
      showP2PStatusModal('–ö—É–ø–∏—Ç—å —ç—Ç–æ—Ç –æ—Ä–¥–µ—Ä?', true, function(){
          doBuyOrder(orderId);
      });
  };

  function doBuyOrder(orderId) {
      fetch("{% url 'p2p:buy_order' %}", {
          method: "POST",
          headers: {
              "Content-Type": "application/x-www-form-urlencoded",
              "X-CSRFToken": "{{ csrf_token }}"
          },
          body: "order_id=" + encodeURIComponent(orderId)
      })
      .then(r => r.json())
      .then(data => {
          showP2PStatusModal(data.msg, !!data.success, function() {
              if (data.success) {
                  updateBuyOrders();
                  document.getElementById('modal-buy').classList.remove('active');
                  document.body.style.overflow = '';
                  location.reload();
              }
          });
      })
      .catch(() => {
          showP2PStatusModal("–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º", false);
      });
  }
});

</script>


{% endblock %}
