{% extends 'base.html' %}
{% block title %}Динамика цены FLORA{% endblock %}
{% block content %}
<style>
.price-graph-container {
  width: 90vw; max-width: 520px; height: 400px; margin: 32px auto 10px auto;
  background: rgba(36,66,255,0.12); border-radius: 22px; box-shadow: 0 2px 28px #b4cbff33;
  position: relative; display: flex; flex-direction: column; align-items: flex-start; overflow: visible;
}
#price-graph-canvas {
  width: 100%; height: 260px; min-height: 150px;
  background: none; display: block; margin: 0; z-index: 1;
}
.graph-header {
  display: flex; justify-content: space-between; align-items: center; width: 100%; padding: 17px 22px 6px 20px;
}
.graph-title { font-size: 1.25rem; color: #fff; font-weight: 700; letter-spacing: 0.03em; }
.graph-price {
  background: linear-gradient(90deg,#3a71d3 10%,#4bc0e5 100%);
  color: #fff; font-weight: 800; font-size: 1.09rem; border-radius: 15px;
  padding: 5px 18px 4px 13px; box-shadow: 0 2px 12px #648fff28; letter-spacing: 0.04em; border: 2px solid #fff3;
}
.graph-caption {
  text-align: center; font-size: 1.13rem; color: #f3f6fa; font-weight: 500; margin-top: 80px;
  pointer-events: none; text-shadow: 0 2px 10px #608ed5b8; width: 100%;
}
@media (max-width: 600px) {
  .price-graph-container { height: 290px; }
  #price-graph-canvas { height: 115px !important; }
  .graph-title { font-size: 1.04rem; }
  .graph-caption { font-size: 0.98rem; }
}
</style>

<div class="price-graph-container">
  <div class="graph-header">
    <span class="graph-title">Динамика цены FLORA</span>
    <span class="graph-price" id="market-price">Цена: —</span>
  </div>
  <canvas id="price-graph-canvas"></canvas>
  <div class="graph-caption">После добычи всех монет откроется <b>P2P</b> рынок</div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const canvas = document.getElementById('price-graph-canvas');
  const ctx = canvas.getContext('2d');
  const priceSpan = document.getElementById('market-price');

  let priceData = [];
  let animPoints = [];
  let days = 8;
  let pointsPerDay = 24;
  let maxPrice = 100;

  // --- Получаем данные с Django ---
  fetch('/p2p/api/price-history/')
    .then(r => r.json())
    .then(json => {
      if (json.history && json.history.length) {
        priceData = json.history.map(x => parseFloat(x[1]));
        // Если только одна точка — моделируем неявный тренд (очень медленный)
        if (priceData.length < days + 1) {
          let last = priceData[priceData.length - 1];
          while (priceData.length < days + 1) {
            // Очень плавно вверх, но максимум до 2₽
            let step = Math.min(0.12, maxPrice - last);
            last = Math.min(last + step, maxPrice);
            priceData.push(last);
          }
        }
        // Интерполируем между днями
        let smooth = [];
        for (let d = 1; d < priceData.length; d++) {
          let open = priceData[d-1];
          let close = priceData[d];
          for (let i = 0; i < pointsPerDay; i++) {
            let frac = i / pointsPerDay;
            let base = open + (close - open) * frac;
            // Не больше 0.07₽ шума, всегда в диапазоне [1, 2]
            let noise = (Math.random() - 0.5) * 0.10;
            let pt = base + noise;
            pt = Math.max(1, Math.min(maxPrice, pt));
            smooth.push(pt);
          }
        }
        animPoints = smooth;
      } else {
        // Нет данных — моделируем в диапазоне [1, 2]
        let price = 1.0;
        for (let d = 0; d < days; d++) {
          let open = price;
          let close = Math.min(open + 0.12, maxPrice);
          for (let i = 0; i < pointsPerDay; i++) {
            let frac = i / pointsPerDay;
            let base = open + (close - open) * frac;
            let noise = (Math.random() - 0.5) * 0.10;
            let pt = base + noise;
            pt = Math.max(1, Math.min(maxPrice, pt));
            animPoints.push(pt);
          }
          price = close;
        }
      }
      drawGraph();
      startAnimation();
    });

  function resizeCanvas() {
    const dpr = window.devicePixelRatio || 1;
    let box = canvas.getBoundingClientRect();
    canvas.width = box.width * dpr;
    canvas.height = box.height * dpr;
    ctx.setTransform(1, 0, 0, 1, 0, 0);
    ctx.scale(dpr, dpr);
  }

  function drawGraph() {
    resizeCanvas();
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.save();
    ctx.strokeStyle = "#fff";
    ctx.lineWidth = 2.1;
    ctx.beginPath();
    let padX = 17, padY = 25;
    let w = canvas.offsetWidth - padX * 2, h = canvas.offsetHeight - padY * 2;
    let max = Math.max(...animPoints), min = Math.min(...animPoints);
    let n = animPoints.length;
    let stepX = w / (n - 1);
    for (let i = 0; i < n; i++) {
      let x = padX + i * stepX;
      let y = padY + h - (h * (animPoints[i] - min) / (max - min + 0.0001));
      if (i === 0) ctx.moveTo(x, y);
      else ctx.lineTo(x, y);
    }
    ctx.shadowColor = "#87d0ff33";
    ctx.shadowBlur = 6;
    ctx.stroke();
    ctx.restore();

    // Цена — последняя точка
    let last = animPoints[n - 1];
    priceSpan.textContent = 'Цена: ' + last.toFixed(2) + '₽';
  }

  function startAnimation() {
    setInterval(() => {
      // Немного двигаем последнюю точку — шум, но не больше ±0.07₽
      let n = animPoints.length;
      let last = animPoints[n-1];
      let prev = animPoints[n-2] || last;
      let delta = (Math.random()-0.5)*0.07;
      // Не позволяем двигаться сильно и только вверх (max 2₽)
      let next = last + delta;
      next = Math.max(1, Math.min(2, next));
      animPoints[n-1] = next;
      drawGraph();
    }, 900); // 0.9 сек — живой график
  }

  window.addEventListener('resize', drawGraph);

});
</script>

{% endblock %}
