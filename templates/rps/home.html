{% extends 'base.html' %}
{% load static %}
{% load mask %}
{% load humanize %}
{% load i18n %}

{% block title %}{% trans "–ö–∞–º–µ–Ω—å-–ù–æ–∂–Ω–∏—Ü—ã-–ë—É–º–∞–≥–∞ ‚Äî CryptoFarm" %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/rps.css' %}">
{% endblock %}

{% block content %}
<div class="rps-container">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="rps-header card">
        <h1>{% trans "üéÆ –ö–∞–º–µ–Ω—å-–ù–æ–∂–Ω–∏—Ü—ã-–ë—É–º–∞–≥–∞" %}</h1>
        <div class="balance-info">
            <span>{% trans "–í–∞—à –±–∞–ª–∞–Ω—Å" %}: <strong>{{ user.cf_balance|floatformat:0|intcomma }} FL</strong></span>
        </div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ –ø–æ–∏—Å–∫–∞ –∏–≥—Ä—ã -->
    <div class="rps-actions">
        <a href="{% url 'rps:game' %}" class="btn-find-game">
            <i class="fa fa-search"></i>
            {% trans "–ù–∞–π—Ç–∏ –∏–≥—Ä—É" %}
        </a>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
    <div class="rps-stats card">
        <h2>{% trans "üìä –í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞" %}</h2>
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-value">{{ user_stats.games_played }}</div>
                <div class="stat-label">{% trans "–ò–≥—Ä —Å—ã–≥—Ä–∞–Ω–æ" %}</div>
            </div>
            <div class="stat-item stat-win">
                <div class="stat-value">{{ user_stats.wins }}</div>
                <div class="stat-label">{% trans "–ü–æ–±–µ–¥" %}</div>
            </div>
            <div class="stat-item stat-draw">
                <div class="stat-value">{{ user_stats.draws }}</div>
                <div class="stat-label">{% trans "–ù–∏—á—å–∏—Ö" %}</div>
            </div>
            <div class="stat-item stat-loss">
                <div class="stat-value">{{ user_stats.losses }}</div>
                <div class="stat-label">{% trans "–ü–æ—Ä–∞–∂–µ–Ω–∏–π" %}</div>
            </div>
        </div>
    </div>

    <!-- –¢—É—Ä–Ω–∏—Ä–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    {% if active_tournament %}
    <div class="rps-tournament card">
        <h2>{% trans "üèÜ –¢–µ–∫—É—â–∏–π —Ç—É—Ä–Ω–∏—Ä" %}</h2>
        <div class="tournament-info">
            {% if tournament_stats %}
            <div class="tournament-stats">
                <div class="tournament-stat">
                    <span class="label">{% trans "–í–∞—à–∏ –æ—á–∫–∏" %}:</span>
                    <span class="value">{{ tournament_stats.points }}</span>
                </div>
                <div class="tournament-stat">
                    <span class="label">{% trans "–í–∞—à–µ –º–µ—Å—Ç–æ" %}:</span>
                    <span class="value">#{{ tournament_stats.rank }}</span>
                </div>
                <div class="tournament-stat">
                    <span class="label">{% trans "–ò–≥—Ä —Å—ã–≥—Ä–∞–Ω–æ" %}:</span>
                    <span class="value">{{ tournament_stats.games_played }}</span>
                </div>
            </div>
            {% else %}
            <p class="no-participation">{% trans "–í—ã –µ—â–µ –Ω–µ —É—á–∞—Å—Ç–≤—É–µ—Ç–µ –≤ —Ç—É—Ä–Ω–∏—Ä–µ. –°—ã–≥—Ä–∞–π—Ç–µ –ø–µ—Ä–≤—É—é –∏–≥—Ä—É" %}!</p>
            {% endif %}
        </div>
    </div>

    <!-- –¢–æ–ø-10 -->
    {% if top_10 %}
    <div class="rps-leaderboard card">
        <h2>{% trans "üèÖ –¢–æ–ø-10 —Ç—É—Ä–Ω–∏—Ä–∞" %}</h2>
        <div class="leaderboard-list">
            {% for participant in top_10 %}
            <div class="leaderboard-item {% if participant.user == user %}current-user{% endif %}">
                <div class="rank">#{{ forloop.counter }}</div>
                <div class="user-info">
                    <div class="username">{{ participant.user|mask_last }}</div>
                    {% blocktrans with pts=participant.points games=participant.games_played %}
{{ pts }} –æ—á–∫–æ–≤ ‚Ä¢ {{ games }} –∏–≥—Ä
{% endblocktrans %}

                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    {% else %}
    <div class="rps-tournament card">
        <h2>{% trans "üèÜ –¢—É—Ä–Ω–∏—Ä" %}</h2>
        <p class="no-tournament">{% trans "–¢—É—Ä–Ω–∏—Ä –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω. –û–∂–∏–¥–∞–π—Ç–µ –∑–∞–ø—É—Å–∫–∞ –Ω–æ–≤–æ–≥–æ —Ç—É—Ä–Ω–∏—Ä–∞." %}</p>
    </div>
    {% endif %}

    <!-- –¢–æ–ø-5 –∏–≥—Ä–æ–∫–æ–≤ -->
    <div class="rps-top-players card">
        <h2>{% trans "üèÜ –¢–æ–ø-5 –∏–≥—Ä–æ–∫–æ–≤" %}</h2>
        <div class="top-players-list" id="top-players-list">
            {% for player in top_5_players %}
            <div class="top-player-item">
                <div class="player-rank">#{{ player.rank }}</div>
                <div class="player-info">
                    <div class="player-name">{{ player.user|mask_last }}</div>
                    <div class="player-stats">
                        <span class="stat-win">{% trans "–ü–æ–±–µ–¥" %}: {{ player.wins }}</span>
                        <span class="stat-loss">{% trans "–ü–æ—Ä–∞–∂–µ–Ω–∏–π" %}: {{ player.losses }}</span>
                        <span class="stat-draw">{% trans "–ù–∏—á—å–∏—Ö" %}: {{ player.draws }}</span>
                    </div>
                </div>
                <div class="player-rating">

                    <div class="total-games">{{ player.total_games }} {% trans "–∏–≥—Ä" %}</div>

                </div>
            </div>
            {% empty %}
            <p class="no-data">{% trans "–ü–æ–∫–∞ –Ω–µ—Ç –∏–≥—Ä–æ–∫–æ–≤" %}</p>
            {% endfor %}
        </div>
    </div>

    <!-- –ò—Å—Ç–æ—Ä–∏—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∏–≥—Ä -->
    <div class="rps-recent-games card">
        <h2>{% trans "üìú –ò—Å—Ç–æ—Ä–∏—è –∏–≥—Ä" %}</h2>
        <div class="recent-games-list" id="recent-games-list">
            {% for game in recent_games %}
            <div class="recent-game-item">
                {% if game.player1 == user %}
                    {% if game.result == 'draw' %}
                        <div class="game-result-icon">ü§ù</div>
                        <div class="game-info">
                            <div class="game-opponent">vs {% if game.is_bot_game %}{{ game.bot_name|default:_("–ë–æ—Ç") }}{% else %}{{ game.player2|mask_last|default:_("–ë–æ—Ç") }}{% endif %}</div>
                            <div class="game-details">{{ game.bet_amount|floatformat:0|intcomma }} FL ‚Ä¢ {{ game.finished_at|date:"d.m H:i" }}</div>
                        </div>
                        <div class="game-amount draw">0 FL</div>
                    {% elif game.result == 'player1_win' %}
                        <div class="game-result-icon">üéâ</div>
                        <div class="game-info">
                            <div class="game-opponent">vs {% if game.is_bot_game %}{{ game.bot_name|default:_("–ë–æ—Ç") }}{% else %}{{ game.player2|mask_last|default:_("–ë–æ—Ç") }}{% endif %}</div>
                            <div class="game-details">{{ game.bet_amount|floatformat:0|intcomma }} FL ‚Ä¢ {{ game.finished_at|date:"d.m H:i" }}</div>
                        </div>
                        <div class="game-amount win">+{{ game.game_bank|floatformat:0|intcomma }} FL</div>
                    {% else %}
                        <div class="game-result-icon">üòî</div>
                        <div class="game-info">
                            <div class="game-opponent">vs {% if game.is_bot_game %}{{ game.bot_name|default:_("–ë–æ—Ç") }}{% else %}{{ game.player2|mask_last|default:_("–ë–æ—Ç") }}{% endif %}</div>
                            <div class="game-details">{{ game.bet_amount|floatformat:0|intcomma }} FL ‚Ä¢ {{ game.finished_at|date:"d.m H:i" }}</div>
                        </div>
                        <div class="game-amount loss">-{{ game.bet_amount|floatformat:0|intcomma }} FL</div>
                    {% endif %}
                {% else %}
                    {% if game.result == 'draw' %}
                        <div class="game-result-icon">ü§ù</div>
                        <div class="game-info">
                            <div class="game-opponent">vs {{ game.player1|mask_last }}</div>
                            <div class="game-details">{{ game.bet_amount|floatformat:0|intcomma }} FL ‚Ä¢ {{ game.finished_at|date:"d.m H:i" }}</div>
                        </div>
                        <div class="game-amount draw">0 FL</div>
                    {% elif game.result == 'player2_win' %}
                        <div class="game-result-icon">üéâ</div>
                        <div class="game-info">
                            <div class="game-opponent">vs {{ game.player1|mask_last }}</div>
                            <div class="game-details">{{ game.bet_amount|floatformat:0|intcomma }} FL ‚Ä¢ {{ game.finished_at|date:"d.m H:i" }}</div>
                        </div>
                        <div class="game-amount win">+{{ game.game_bank|floatformat:0|intcomma }} FL</div>
                    {% else %}
                        <div class="game-result-icon">üòî</div>
                        <div class="game-info">
                            <div class="game-opponent">vs {{ game.player1|mask_last }}</div>
                            <div class="game-details">{{ game.bet_amount|floatformat:0|intcomma }} FL ‚Ä¢ {{ game.finished_at|date:"d.m H:i" }}</div>
                        </div>
                        <div class="game-amount loss">-{{ game.bet_amount|floatformat:0|intcomma }} FL</div>
                    {% endif %}
                {% endif %}
            </div>
            {% empty %}
            <p class="no-data">{% trans "–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å—ã–≥—Ä–∞–Ω–Ω—ã—Ö –∏–≥—Ä" %}</p>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/rps.js' %}"></script>
    <script>
  window.I18N_RPS = {
    wins: "{% trans '–ü–æ–±–µ–¥' %}",
    losses: "{% trans '–ü–æ—Ä–∞–∂–µ–Ω–∏–π' %}",
    draws: "{% trans '–ù–∏—á—å–∏—Ö' %}",
    games: "{% trans '–∏–≥—Ä' %}",
    no_recent_games: "{% trans '–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å—ã–≥—Ä–∞–Ω–Ω—ã—Ö –∏–≥—Ä' %}",
    no_players: "{% trans '–ü–æ–∫–∞ –Ω–µ—Ç –∏–≥—Ä–æ–∫–æ–≤' %}",
    vs: "{% trans 'vs' %}",
  };
</script>

   <script>
  window.I18N_RPS = {
    // –æ–±—â–∏–µ
    wins: "{% trans '–ü–æ–±–µ–¥' %}",
    losses: "{% trans '–ü–æ—Ä–∞–∂–µ–Ω–∏–π' %}",
    draws: "{% trans '–ù–∏—á—å–∏—Ö' %}",
    games: "{% trans '–∏–≥—Ä' %}",
    vs: "{% trans 'vs' %}",

    // —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è/–æ—à–∏–±–∫–∏
    result_too_long: "{% trans '–†–µ–∑—É–ª—å—Ç–∞—Ç –¥–æ–ª–≥–æ –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç. –û–±–Ω–æ–≤–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—É.' %}",
    opponent_found: "{% trans '–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫ –Ω–∞–π–¥–µ–Ω!' %}",
    search_error: "{% trans '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –∏–≥—Ä—ã' %}",
    bot_connecting: "{% trans '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ ...' %}",
    bot_connected: "{% trans '–ü–æ–¥–∫–ª—é—á–µ–Ω!' %}",
    bot_connect_error: "{% trans '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –±–æ—Ç–∞' %}",
    search_cancelled: "{% trans '–ü–æ–∏—Å–∫ –æ—Ç–º–µ–Ω–µ–Ω' %}",
    id_not_found: "{% trans '–û—à–∏–±–∫–∞: ID –∏–≥—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω' %}",
    cancel_confirm: "{% trans '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å –∏–≥—Ä—É? –°—Ç–∞–≤–∫–∏ –±—É–¥—É—Ç –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã.' %}",
    cancel_success: "{% trans '–ò–≥—Ä–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞, —Å—Ç–∞–≤–∫–∏ –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã' %}",
    cancel_error_prefix: "{% trans '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –∏–≥—Ä—ã: ' %}",
    time_extra: "{% trans '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –≤—Ä–µ–º—è: +7 —Å–µ–∫—É–Ω–¥' %}",
    time_over: "{% trans '–í—Ä–µ–º—è –≤—ã—à–ª–æ!' %}",
    wait_result: "{% trans '–û–∂–∏–¥–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç...' %}",
    move_error: "{% trans '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–≤–µ—Ä—à–µ–Ω–∏–∏ —Ö–æ–¥–∞' %}",
    rematch_created: "{% trans '–ù–æ–≤–∞—è –∏–≥—Ä–∞ —Å–æ–∑–¥–∞–Ω–∞!' %}",
    rematch_error: "{% trans '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–π –∏–≥—Ä—ã' %}",

    // –∫–Ω–æ–ø–∫–∏
    rematch_btn: "{% trans 'üîÅ –ï—â—ë —Ä–∞–∑' %}",
    exit_btn: "{% trans 'üö™ –í—ã–π—Ç–∏' %}",

    // —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω (finalizeGameUI)
    game_cancelled_title: "{% trans '‚è±Ô∏è –ò–≥—Ä–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞' %}",
    game_cancelled_text: "{% trans '–û–¥–∏–Ω –∏–∑ –∏–≥—Ä–æ–∫–æ–≤ –Ω–µ —Å–¥–µ–ª–∞–ª –≤—ã–±–æ—Ä. –°—Ç–∞–≤–∫–∏ –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã.' %}",

    draw_title: "{% trans 'ü§ù –ù–∏—á—å—è!' %}",
    draw_text: "{% trans '–°—Ç–∞–≤–∫–∏ –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã' %}",

    win_title: "{% trans 'üéâ –í—ã –≤—ã–∏–≥—Ä–∞–ª–∏!' %}",
    win_got_prefix: "{% trans '–í—ã –ø–æ–ª—É—á–∏–ª–∏' %}",
    congrats: "{% trans '–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!' %}",

    lose_title: "{% trans 'üòî –í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏' %}",
    lose_text: "{% trans '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑!' %}",

    game_finished_title: "{% trans '‚úÖ –ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞' %}",
    game_finished_text: "{% trans '–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–ª—É—á–µ–Ω.' %}",
  };
</script>



<script>
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–ø-5 –∏–≥—Ä–æ–∫–æ–≤
    function updateTopPlayers() {
        fetch('/rps/api/top-players/')
            .then(response => response.json())
            .then(data => {
                if (data.players && data.players.length > 0) {
                    const list = document.getElementById('top-players-list');
                    list.innerHTML = '';

                    data.players.forEach(player => {
                        const item = document.createElement('div');
                        item.className = 'top-player-item';
                        const t = window.I18N_RPS;

                        item.innerHTML = `
                            <div class="player-rank">#${player.rank}</div>
                            <div class="player-info">
                                <div class="player-name">${player.username}</div>
                                <div class="player-stats">
                                    <span class="stat-win">${t.wins}: ${player.wins}</span>
                                    <span class="stat-loss">${t.losses}: ${player.losses}</span>
                                    <span class="stat-draw">${t.draws}: ${player.draws}</span>
                                </div>
                            </div>
                            <div class="player-rating">

                                <div class="total-games">${player.total_games} ${t.games}</div>
                            </div>
                        `;
                        list.appendChild(item);
                    });
                }
            })
            .catch(error => console.error('Error loading top players:', error));
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –∏–≥—Ä
    function updateRecentGames() {
        const t = window.I18N_RPS || {};
        fetch('/rps/api/recent-games/')
            .then(response => response.json())
            .then(data => {
                if (data.games && data.games.length > 0) {
                    const list = document.getElementById('recent-games-list');
                    list.innerHTML = '';

                    data.games.forEach(game => {
                        const item = document.createElement('div');
                        item.className = 'recent-game-item';
                        item.innerHTML = `
                            <div class="game-result-icon">${game.result === 'win' ? 'üéâ' : game.result === 'loss' ? 'üòî' : 'ü§ù'}</div>
                            <div class="game-info">
                                <div class="game-opponent">${t.vs} ${game.opponent}</div>
                                <div class="game-details">${game.bet_amount} FL ‚Ä¢ ${game.date}</div>
                            </div>
                            <div class="game-amount ${game.result}">${game.result === 'win' ? '+' : game.result === 'loss' ? '-' : ''}${game.amount} FL</div>
                        `;
                        list.appendChild(item);
                    });
                } else {
                    const list = document.getElementById('recent-games-list');
                    list.innerHTML = `<p class="no-data">${t.no_recent_games}</p>`;

                }
            })
            .catch(error => console.error('Error loading recent games:', error));
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
        updateTopPlayers();
        updateRecentGames();

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
        setInterval(function() {
            updateTopPlayers();
            updateRecentGames();
        }, 30000);
    });
</script>
{% endblock %}

