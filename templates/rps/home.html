{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}–ö–∞–º–µ–Ω—å-–ù–æ–∂–Ω–∏—Ü—ã-–ë—É–º–∞–≥–∞ ‚Äî CryptoFarm{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/rps.css' %}">
{% endblock %}

{% block content %}
<div class="rps-container">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="rps-header card">
        <h1>üéÆ –ö–∞–º–µ–Ω—å-–ù–æ–∂–Ω–∏—Ü—ã-–ë—É–º–∞–≥–∞</h1>
        <div class="balance-info">
            <span>–í–∞—à –±–∞–ª–∞–Ω—Å: <strong>{{ user.cf_balance|floatformat:0|intcomma }} FL</strong></span>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
    <div class="rps-stats card">
        <h2>üìä –í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-value">{{ user_stats.games_played }}</div>
                <div class="stat-label">–ò–≥—Ä —Å—ã–≥—Ä–∞–Ω–æ</div>
            </div>
            <div class="stat-item stat-win">
                <div class="stat-value">{{ user_stats.wins }}</div>
                <div class="stat-label">–ü–æ–±–µ–¥</div>
            </div>
            <div class="stat-item stat-draw">
                <div class="stat-value">{{ user_stats.draws }}</div>
                <div class="stat-label">–ù–∏—á—å–∏—Ö</div>
            </div>
            <div class="stat-item stat-loss">
                <div class="stat-value">{{ user_stats.losses }}</div>
                <div class="stat-label">–ü–æ—Ä–∞–∂–µ–Ω–∏–π</div>
            </div>
        </div>
    </div>

    <!-- –¢—É—Ä–Ω–∏—Ä–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    {% if active_tournament %}
    <div class="rps-tournament card">
        <h2>üèÜ –¢–µ–∫—É—â–∏–π —Ç—É—Ä–Ω–∏—Ä</h2>
        <div class="tournament-info">
            {% if tournament_stats %}
            <div class="tournament-stats">
                <div class="tournament-stat">
                    <span class="label">–í–∞—à–∏ –æ—á–∫–∏:</span>
                    <span class="value">{{ tournament_stats.points }}</span>
                </div>
                <div class="tournament-stat">
                    <span class="label">–í–∞—à–µ –º–µ—Å—Ç–æ:</span>
                    <span class="value">#{{ tournament_stats.rank }}</span>
                </div>
                <div class="tournament-stat">
                    <span class="label">–ò–≥—Ä —Å—ã–≥—Ä–∞–Ω–æ:</span>
                    <span class="value">{{ tournament_stats.games_played }}</span>
                </div>
            </div>
            {% else %}
            <p class="no-participation">–í—ã –µ—â–µ –Ω–µ —É—á–∞—Å—Ç–≤—É–µ—Ç–µ –≤ —Ç—É—Ä–Ω–∏—Ä–µ. –°—ã–≥—Ä–∞–π—Ç–µ –ø–µ—Ä–≤—É—é –∏–≥—Ä—É!</p>
            {% endif %}
        </div>
    </div>

    <!-- –¢–æ–ø-10 -->
    {% if top_10 %}
    <div class="rps-leaderboard card">
        <h2>üèÖ –¢–æ–ø-10 —Ç—É—Ä–Ω–∏—Ä–∞</h2>
        <div class="leaderboard-list">
            {% for participant in top_10 %}
            <div class="leaderboard-item {% if participant.user == user %}current-user{% endif %}">
                <div class="rank">#{{ forloop.counter }}</div>
                <div class="user-info">
                    <div class="username">{{ participant.user }}</div>
                    <div class="user-stats">{{ participant.points }} –æ—á–∫–æ–≤ ‚Ä¢ {{ participant.games_played }} –∏–≥—Ä</div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    {% else %}
    <div class="rps-tournament card">
        <h2>üèÜ –¢—É—Ä–Ω–∏—Ä</h2>
        <p class="no-tournament">–¢—É—Ä–Ω–∏—Ä –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω. –û–∂–∏–¥–∞–π—Ç–µ –∑–∞–ø—É—Å–∫–∞ –Ω–æ–≤–æ–≥–æ —Ç—É—Ä–Ω–∏—Ä–∞.</p>
    </div>
    {% endif %}

    <!-- –ö–Ω–æ–ø–∫–∞ –ø–æ–∏—Å–∫–∞ –∏–≥—Ä—ã -->
    <div class="rps-actions">
        <a href="{% url 'rps:game' %}" class="btn-find-game">
            <i class="fa fa-search"></i>
            –ù–∞–π—Ç–∏ –∏–≥—Ä—É
        </a>
    </div>
    
    <!-- –¢–æ–ø-5 –∏–≥—Ä–æ–∫–æ–≤ -->
    <div class="rps-top-players card">
        <h2>üèÜ –¢–æ–ø-5 –∏–≥—Ä–æ–∫–æ–≤</h2>
        <div class="top-players-list" id="top-players-list">
            {% for player in top_5_players %}
            <div class="top-player-item">
                <div class="player-rank">#{{ player.rank }}</div>
                <div class="player-info">
                    <div class="player-name">{{ player.user }}</div>
                    <div class="player-stats">
                        <span class="stat-win">–ü–æ–±–µ–¥: {{ player.wins }}</span>
                        <span class="stat-loss">–ü–æ—Ä–∞–∂–µ–Ω–∏–π: {{ player.losses }}</span>
                        <span class="stat-draw">–ù–∏—á—å–∏—Ö: {{ player.draws }}</span>
                    </div>
                </div>
                <div class="player-rating">
                    <div class="win-rate">{{ player.win_rate|floatformat:1 }}%</div>
                    <div class="total-games">{{ player.total_games }} –∏–≥—Ä</div>
                </div>
            </div>
            {% empty %}
            <p class="no-data">–ü–æ–∫–∞ –Ω–µ—Ç –∏–≥—Ä–æ–∫–æ–≤</p>
            {% endfor %}
        </div>
    </div>

    <!-- –ò—Å—Ç–æ—Ä–∏—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∏–≥—Ä -->
    <div class="rps-recent-games card">
        <h2>üìú –ò—Å—Ç–æ—Ä–∏—è –∏–≥—Ä</h2>
        <div class="recent-games-list" id="recent-games-list">
            {% for game in recent_games %}
            <div class="recent-game-item">
                {% if game.player1 == user %}
                    {% if game.result == 'draw' %}
                        <div class="game-result-icon">ü§ù</div>
                        <div class="game-info">
                            <div class="game-opponent">vs {{ game.player2|default:"–ë–æ—Ç" }}</div>
                            <div class="game-details">{{ game.bet_amount|floatformat:0|intcomma }} FL ‚Ä¢ {{ game.finished_at|date:"d.m H:i" }}</div>
                        </div>
                        <div class="game-amount draw">0 FL</div>
                    {% elif game.result == 'player1_win' %}
                        <div class="game-result-icon">üéâ</div>
                        <div class="game-info">
                            <div class="game-opponent">vs {{ game.player2|default:"–ë–æ—Ç" }}</div>
                            <div class="game-details">{{ game.bet_amount|floatformat:0|intcomma }} FL ‚Ä¢ {{ game.finished_at|date:"d.m H:i" }}</div>
                        </div>
                        <div class="game-amount win">+{{ game.game_bank|floatformat:0|intcomma }} FL</div>
                    {% else %}
                        <div class="game-result-icon">üòî</div>
                        <div class="game-info">
                            <div class="game-opponent">vs {{ game.player2|default:"–ë–æ—Ç" }}</div>
                            <div class="game-details">{{ game.bet_amount|floatformat:0|intcomma }} FL ‚Ä¢ {{ game.finished_at|date:"d.m H:i" }}</div>
                        </div>
                        <div class="game-amount loss">-{{ game.bet_amount|floatformat:0|intcomma }} FL</div>
                    {% endif %}
                {% else %}
                    {% if game.result == 'draw' %}
                        <div class="game-result-icon">ü§ù</div>
                        <div class="game-info">
                            <div class="game-opponent">vs {{ game.player1 }}</div>
                            <div class="game-details">{{ game.bet_amount|floatformat:0|intcomma }} FL ‚Ä¢ {{ game.finished_at|date:"d.m H:i" }}</div>
                        </div>
                        <div class="game-amount draw">0 FL</div>
                    {% elif game.result == 'player2_win' %}
                        <div class="game-result-icon">üéâ</div>
                        <div class="game-info">
                            <div class="game-opponent">vs {{ game.player1 }}</div>
                            <div class="game-details">{{ game.bet_amount|floatformat:0|intcomma }} FL ‚Ä¢ {{ game.finished_at|date:"d.m H:i" }}</div>
                        </div>
                        <div class="game-amount win">+{{ game.game_bank|floatformat:0|intcomma }} FL</div>
                    {% else %}
                        <div class="game-result-icon">üòî</div>
                        <div class="game-info">
                            <div class="game-opponent">vs {{ game.player1 }}</div>
                            <div class="game-details">{{ game.bet_amount|floatformat:0|intcomma }} FL ‚Ä¢ {{ game.finished_at|date:"d.m H:i" }}</div>
                        </div>
                        <div class="game-amount loss">-{{ game.bet_amount|floatformat:0|intcomma }} FL</div>
                    {% endif %}
                {% endif %}
            </div>
            {% empty %}
            <p class="no-data">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å—ã–≥—Ä–∞–Ω–Ω—ã—Ö –∏–≥—Ä</p>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/rps.js' %}"></script>
<script>
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–ø-5 –∏–≥—Ä–æ–∫–æ–≤
    function updateTopPlayers() {
        fetch('/rps/api/top-players/')
            .then(response => response.json())
            .then(data => {
                if (data.players && data.players.length > 0) {
                    const list = document.getElementById('top-players-list');
                    list.innerHTML = '';
                    
                    data.players.forEach(player => {
                        const item = document.createElement('div');
                        item.className = 'top-player-item';
                        item.innerHTML = `
                            <div class="player-rank">#${player.rank}</div>
                            <div class="player-info">
                                <div class="player-name">${player.username}</div>
                                <div class="player-stats">
                                    <span class="stat-win">–ü–æ–±–µ–¥: ${player.wins}</span>
                                    <span class="stat-loss">–ü–æ—Ä–∞–∂–µ–Ω–∏–π: ${player.losses}</span>
                                    <span class="stat-draw">–ù–∏—á—å–∏—Ö: ${player.draws}</span>
                                </div>
                            </div>
                            <div class="player-rating">
                                <div class="win-rate">${parseFloat(player.win_rate).toFixed(1)}%</div>
                                <div class="total-games">${player.total_games} –∏–≥—Ä</div>
                            </div>
                        `;
                        list.appendChild(item);
                    });
                }
            })
            .catch(error => console.error('Error loading top players:', error));
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –∏–≥—Ä
    function updateRecentGames() {
        fetch('/rps/api/recent-games/')
            .then(response => response.json())
            .then(data => {
                if (data.games && data.games.length > 0) {
                    const list = document.getElementById('recent-games-list');
                    list.innerHTML = '';
                    
                    data.games.forEach(game => {
                        const item = document.createElement('div');
                        item.className = 'recent-game-item';
                        item.innerHTML = `
                            <div class="game-result-icon">${game.result === 'win' ? 'üéâ' : game.result === 'loss' ? 'üòî' : 'ü§ù'}</div>
                            <div class="game-info">
                                <div class="game-opponent">vs ${game.opponent}</div>
                                <div class="game-details">${game.bet_amount} FL ‚Ä¢ ${game.date}</div>
                            </div>
                            <div class="game-amount ${game.result}">${game.result === 'win' ? '+' : game.result === 'loss' ? '-' : ''}${game.amount} FL</div>
                        `;
                        list.appendChild(item);
                    });
                } else {
                    const list = document.getElementById('recent-games-list');
                    list.innerHTML = '<p class="no-data">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å—ã–≥—Ä–∞–Ω–Ω—ã—Ö –∏–≥—Ä</p>';
                }
            })
            .catch(error => console.error('Error loading recent games:', error));
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
        updateTopPlayers();
        updateRecentGames();
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
        setInterval(function() {
            updateTopPlayers();
            updateRecentGames();
        }, 30000);
    });
</script>
{% endblock %}

