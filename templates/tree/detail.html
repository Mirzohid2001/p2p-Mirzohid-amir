{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}FLORA Дерево{% endblock %}

{% block content %}
<style>
.container, .container-fluid {
    padding-left: 0 !important;
    padding-right: 0 !important;
    margin-left: 0 !important;
    margin-right: 0 !important;
    margin-top: 0 !important;
    padding-top: 0 !important;
    width: 100vw !important;
    max-width: 100vw !important;
}
body, html {
  height: 80%;
  margin: 0;
  padding: 0;
}
.tree-figma-bg {
  min-height: 80vh;
  min-width: 90vw;
  background: url('{% static "images/bg.png" %}') center bottom/cover no-repeat, #4336a7;
  padding-bottom: 70px;
  position: relative;
  margin: 0;

}

.tree-header-row {
  display: flex;
  align-items: center;
  padding: 18px 18px 8px 12px;
}
.tree-back-btn {
  display: flex;
  align-items: center;
  margin-right: 8px;
  border-radius: 100px;
  background: transparent;
  padding: 4px;
  border: none;
}
.tree-header-title {
  color: #fff;
  font-weight: bold;
  font-size: 1.25rem;
  letter-spacing: 0.5px;
}


.tree-main-row {
  display: flex;
  flex-direction: row;
  align-items: flex-start;
  margin: 18px 0 0 0;
  width: 100%;
  gap: 20px;
}
.modal-success {
  background: linear-gradient(90deg,#31c54e 10%, #45e7b1 100%) !important;
}
.modal-error {
  background: linear-gradient(90deg,#c53931 10%, #e76a45 100%) !important;
}
.tree-btns-col {
  display: flex;
  flex-direction: column;
  gap: 3px;
  min-width: 80px;
  margin-left: 10px;
}
.tree-info-card {
  background: rgba(34, 38, 82, 0.12);
  border: 1.5px solid #d2d5e7;
  border-radius: 15px;
  padding: 16px 22px 16px 18px;
  min-width: 195px;
  box-shadow: 0 2px 12px #0f256121;
  color: #3d3970;
  font-size: 1.1rem;
  margin-left: 0;
  margin-top: 3px;
  position: relative;
  z-index: 2;
}
.info-row {
  display: flex;
  flex-direction: row;
  justify-content: flex-start;
  align-items: baseline;
  margin-bottom: 7px;
}
.info-label {
  min-width: 90px;
  font-weight: 400;
  color: #3a247a;
  font-size: 0.9rem;
  margin-right: 3px;
}
.info-value {
  font-weight: 400;
  color: #fff;
  font-size: 0.9rem;
}
.info-value.active {
  color: #16b95e;
  font-weight: 400;
}
.info-value.not-active {
  color: #b4b2d6;
  font-weight: 400;
}

.tree-btn {
  width: 100%;
  padding: 10px 0;
  border: none;
  border-radius: 25px;
  background: linear-gradient(90deg, #3a247a 10%, #5333da 100%);
  color: #fff;
  font-size: 0.8rem;
  font-weight: 500;
  box-shadow: 0 2px 12px 0 #0002;
  cursor: pointer;
  transition: background 0.15s;
  outline: none;
}
.tree-btn:active, .tree-btn:focus {
  background: linear-gradient(90deg, #4631c7 20%, #2e57f5 100%);
}
.tree-btn[disabled] {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Info block */
.tree-info-block {
  flex: 1;
  background: rgba(255,255,255,0.18);
  border-radius: 16px;
  border: 1.5px solid #fff4;
  box-shadow: 0 2px 8px #fff2;
  padding: 18px 16px 18px 20px;
  color: #334;
  font-size: 1.08rem;
  margin-left: 0;
  min-width: 165px;
  max-width: 195px;
}
.tree-info-block b {
  color: #3522a8;
  font-weight: 600;
  letter-spacing: 0.1px;
}
.tree-info-block .active {
  color: #17c361;
}
.tree-info-block .not-active {
  color: #a49fd0;
  font-weight: 500;
}

/* Дерево и прогресс */
.tree-image-wrap {
  width: 100px;
  min-height: 200px;
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-top: 14px;
  margin-bottom: 30px;
}
.tree-img {
  width: 50vw;
  max-width: 350px;
  min-width: 160px;
  height: auto;
  display: block;
  margin: 0 auto 8px auto;
  z-index: 1;
  position: relative;
}
.tree-water-can {
  position: absolute;
  right: 22vw;
  bottom: 38px;
  width: 60px;
  opacity: 0.94;
  z-index: 2;
  pointer-events: none;
}
.tree-progress-bar-wrap {
  width: 80vw;
  max-width: 330px;
  min-width: 145px;
  display: flex;
  align-items: center;
  justify-content: flex-start;
  margin: 10px 0 0 7vw;
  position: relative;
  z-index: 2;
}
.tree-progress-bar {
  flex: 1;
  height: 17px;
  border-radius: 15px;
  background: linear-gradient(90deg, #18165b 0%, #4d4cae 100%);
  overflow: hidden;
  box-shadow: 0 1px 8px #0a1c3a2f;
  position: relative;
}
.tree-progress-inner {
  height: 100%;
  border-radius: 15px 0 0 15px;
  background: linear-gradient(90deg, #67f9f1 0%, #845ef7 100%);
  box-shadow: 0 2px 8px #22e6fc32 inset;
  transition: width 1s cubic-bezier(0.32,0,0.67,1);
}
.tree-progress-icon {
  position: absolute;
  right: -30px;
  top: 50%;
  transform: translateY(-50%);
  width: 32px;
  height: 32px;
  z-index: 3;
  filter: drop-shadow(0 2px 6px #a5d6ff55);
}

/* Footer меню */
.tree-footer-menu {
  position: fixed;
  bottom: 0; left: 0; right: 0;
  z-index: 20;
  width: 100vw;
  background: linear-gradient(90deg, #241c62 30%, #543ae0 100%);
  border-radius: 30px 30px 0 0;
  box-shadow: 0 -2px 30px #091c3a35;
  display: flex;
  justify-content: space-around;
  align-items: center;
  padding: 12px 0 8px 0;
}
.footer-icon {
  flex: 1;
  text-align: center;
  color: #fff;
  font-size: 1rem;
  text-decoration: none;
  opacity: 0.97;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 3px;
  transition: opacity 0.15s;
}
.footer-icon.active, .footer-icon:active, .footer-icon:focus {
  opacity: 1;
  color: #f6e5ff;
}
.footer-icon img {
  width: 32px; height: 32px; margin-bottom: 0;
  filter: drop-shadow(0 2px 6px #c6dfffbb);
}
.footer-icon span {
  font-size: 0.89rem;
  font-weight: 500;
  margin-top: 1px;
  letter-spacing: 0.1px;
}

/* Mobile адаптация */
@media (max-width: 600px) {

  .tree-info-block { min-width: 135px; max-width: 165px; padding: 12px 10px 14px 12px; }
  .tree-btns-col { min-width: 90px; width: 105px; }
  .tree-img { min-width: 110px; }
  .tree-progress-bar-wrap { min-width: 100px; }
}
.timer-block {
  display: flex;
  align-items: center;
  justify-content: flex-start;
  gap: 5px;
  margin: 10px 0 0 0;
  padding: 10px 20px;
  background: linear-gradient(90deg, #282259 0%, #4533b8 100%);
  border-radius: 15px;
  box-shadow: 0 2px 20px #0002, 0 1.5px 0 #5942e01a inset;
  color: #fff;
  font-size: 0.8rem;
  font-weight: 400;
  letter-spacing: 0.03em;
  border: 1.5px solid #554ecb44;
  min-width: 100px;
  max-width: 50vw;
  animation: timer-pop-in 0.7s cubic-bezier(.42,0,.32,1.56);
}
@keyframes timer-pop-in {
  from { transform: translateY(18px) scale(.96); opacity: 0; }
  to   { transform: none; opacity: 1; }
}
#timer {
  background: rgba(36,219,239,0.14);
  padding: 3px 14px;
  margin-left: 10px;
  border-radius: 11px;
  font-size: 0.7rem;
  color: #2fffd6;
  font-weight: 500;
  letter-spacing: 0.03em;
  box-shadow: 0 1px 6px #19e5d533 inset;
  border: 1px solid #1e96c811;
  transition: background 0.25s, color 0.25s;
}
.custom-modal {
  display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100vw; height: 100vh;
  background: rgba(44, 50, 81, 0.48); justify-content: center; align-items: center;
}
.custom-modal.active { display: flex; }
.custom-modal-content {
  background: linear-gradient(90deg,#3a247a 10%, #368fff 100%);
  padding: 32px 24px 24px 24px;
  border-radius: 20px;
  box-shadow: 0 6px 28px #23286948;
  min-width: 270px; max-width: 94vw;
  position: relative;
  text-align: center;
}
.custom-modal-close {
  position: absolute; right: 16px; top: 10px; font-size: 2rem; color: #aaa; cursor: pointer;
}
.modal-status.active { color: #27be6c; font-weight: bold; margin-bottom: 9px; }
.modal-status.not-active { color: #a4a4be; font-weight: bold; margin-bottom: 9px; }
.modal-action-btn {
  background: linear-gradient(90deg,#3a247a 10%, #368fff 100%);
  color: #fff; border: none; border-radius: 13px; padding: 10px 32px; font-size: 1.1rem;
  margin-top: 18px; cursor: pointer; font-weight: 600;
  box-shadow: 0 2px 12px #3a247a22;
  transition: background 0.13s;
}
.modal-action-btn:active { background: linear-gradient(90deg,#4823b7 20%, #259aff 100%);}

.inline-inventory-row {
  display: flex;
  align-items: center;

  border-radius: 13px;
  box-shadow: 0 1px 8px #b7d4fc1a;
  padding: 8px 10px;
  margin-bottom: 16px;
  gap: 14px;
}
.inventory-img-small {
  width: 36px;
  height: 36px;
  object-fit: contain;
  border-radius: 7px;


  margin-right: 8px;
}
.inline-inventory-title {
  flex: 1;
  font-size: 0.8rem;
  font-weight: 600;
  color: #fff;
}
.inline-inventory-btn {
  background: linear-gradient(90deg,#48e6a8,#28b7fc 90%);
  border: none;
  border-radius: 8px;
  color: #fff;
  font-size: 0.8rem;
  font-weight: 600;
  padding: 6px 18px;
  box-shadow: 0 1px 7px #13e4c928;
  margin-left: 10px;
  cursor: pointer;
  transition: background 0.13s;
  white-space: nowrap;
}
.inline-inventory-btn:active, .inline-inventory-btn:focus {
  background: linear-gradient(90deg,#16d3c3,#1a83ea 80%);
}

.modal-success {
  background: linear-gradient(90deg,#3a247a 10%, #368fff 100%) !important;
}
.modal-error {
  background: linear-gradient(90deg,#3a247a 10%, #368fff 100%) !important;
}



</style>

<div class="tree-figma-bg">

  <!-- Хедер -->
  <div class="tree-header-row">
    <a href="/" class="tree-back-btn">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
      </svg>
    </a>
    <span class="tree-header-title">
  {% if tree.type == "TON" %}
    TON Дерево
  {% else %}
    FLORA Дерево
  {% endif %}
</span>

  </div>

  <!-- CF Summary -->
  <div class="cf-summary-block">
    <div>Создано FL: {{ total_created_cf|intcomma }}</div>
    <div>Выращено: {{ all_cf_grown|floatformat:0|intcomma }}</div>
    <div>Осталось: {{ cf_left|floatformat:0|intcomma }}</div>
  </div>

  {% if messages %}
<div class="messages-wrap">
    {% for message in messages %}
        <div class="custom-message custom-message-{{ message.tags }}">
            {{ message }}
        </div>
    {% endfor %}
</div>
{% endif %}


  <!-- Основной блок с кнопками и инфо -->
  <div class="tree-main-row">
  <div class="tree-btns-col">
  <button class="tree-btn btn-water" data-tree-id="{{ tree.id }}" {% if not can_water or is_auto_watered %}disabled{% endif %}>Полить</button>

<button class="tree-btn btn-collect" data-tree-id="{{ tree.id }}" {% if not can_collect %}disabled{% endif %}>Собрать</button>

  <button class="tree-btn btn-use-item open-modal-btn" data-modal="autowater-modal">Автополив</button>
  <button class="tree-btn btn-use-item open-modal-btn" data-modal="fertilizer-modal">Удобрение</button>
  <button class="tree-btn btn-upgrade" data-tree-id="{{ tree.id }}">Улучшить</button>
</div>




  <div class="tree-info-card">
  {% if tree.type == "TON" %}
    <div class="info-row">
      <span class="info-label">Уровень:</span>
      <span class="info-value">{{ tree.level }}</span>
    </div>
    <div class="info-row">
      <span class="info-label">TON за полив:</span>
<span class="info-value">
    <b>
      {% if is_fertilized %}
        {{ ton_per_water_base|floatformat:2 }} × 2 = {{ ton_per_water|floatformat:2 }}
      {% else %}
        {{ ton_per_water|floatformat:2 }}
      {% endif %}
    </b> TON
  </span>
    </div>
    <div class="info-row">
      <span class="info-label">Осталось в пуле:</span>
      <span class="info-value"><b>{% if ton_left %}{{ ton_left|floatformat:2 }}{% else %}0.00{% endif %}</b> TON</span>
    </div>
    <div class="info-row">
      <span class="info-label">Автополив:</span>
      <span class="info-value">{% if is_auto_watered %} Активен {% else %} Не активен {% endif %}</span>
    </div>
    <div class="info-row">
      <span class="info-label">Удобрение:</span>
      <span class="info-value">{% if is_fertilized %} Активно {% else %} Не активно {% endif %}</span>
    </div>
    {% if tree.type == "TON" %}
 {% if pending_income > 0 %}
    <div class="info-row" style="margin-top: 12px;">
      <span class="info-label" style="color:#1ec97f; font-weight:600;">К сбору:</span>
      <span class="info-value" style="color:#22e488; font-weight:700; font-size:1.15em;">
        {{ pending_income|floatformat:4 }} TON
      </span>
    </div>
  {% endif %}

{% else %}
  ...
  {% if pending_income > 0 %}
  <div class="info-row" style="margin-top: 12px;">
    <span class="info-label" style="color:#1ec97f; font-weight:600;">К сбору:</span>
    <span class="info-value" style="color:#22e488; font-weight:700; font-size:1.15em;">
      {{ pending_income|floatformat:1 }} FL
    </span>
  </div>
  {% endif %}
{% endif %}

  {% else %}
    <div class="info-row">
      <span class="info-label">Уровень:</span>
      <span class="info-value">{{ tree.level }}</span>
    </div>
    <div class="info-row">
      <span class="info-label">Доход в час:</span>
      <span class="info-value">
        {% if is_fertilized %}
          {{ income_per_hour|floatformat:1 }} + {{ income_per_hour|floatformat:1 }} = <b>{{ total_income|floatformat:1 }}</b>  FL
        {% else %}
          {{ income_per_hour|floatformat:1 }} FL
        {% endif %}
      </span>
    </div>
    <div class="info-row">
      <span class="info-label">Ветки:</span>
      <span class="info-value">
        {{ tree.branches_collected }}
        /
        {% if tree.level == 1 %}5
        {% elif tree.level == 2 %}12
        {% elif tree.level == 3 %}30
        {% elif tree.level == 4 %}75
        {% else %}MAX{% endif %}
      </span>
    </div>
    <div class="info-row">
      <span class="info-label">Автополив:</span>
      <span class="info-value">{% if is_auto_watered %} Активен {% else %} Не активен {% endif %}</span>
    </div>
    <div class="info-row">
      <span class="info-label">Удобрение:</span>
      <span class="info-value">{% if is_fertilized %} Активно {% else %} Не активно {% endif %}</span>
    </div>
    {% if pending_income > 0 %}
    <div class="info-row" style="margin-top: 12px;">
      <span class="info-label" style="color:#1ec97f; font-weight:600;">К сбору:</span>
      <span class="info-value" style="color:#22e488; font-weight:700; font-size:1.15em;">
        {{ pending_income|floatformat:1 }} FL
      </span>
    </div>
    {% endif %}
  {% endif %}
</div>


</div>




  <!-- Дерево и низ -->
  <div class="tree-image-wrap">
    {% if tree.type == "TON" %}
        <img src="{% static 'images/ton_' %}{{ tree.level }}.png" class="tree-img" alt="TON Tree">
    {% else %}
        <img src="{% static 'images/tree_' %}{{ tree.level }}.png" class="tree-img" alt="Tree">
    {% endif %}
</div>

  <!-- Фиксированное меню снизу -->

</div>

<div id="autowater-modal" class="custom-modal">
  <div class="custom-modal-content">
    <span class="custom-modal-close" data-modal-close>&times;</span>
    <h3 style="text-align:left; margin-left:8px;">Автополив</h3>
    {% if is_auto_watered %}
      <div class="inline-inventory-row">
        <img src="{% static 'images/watering_can.png' %}" alt="Автополив" class="inventory-img-small">
        <span class="inline-inventory-title">Автополив {{ auto_water_duration }}</span>
        <span style="font-size:0.96rem; color:#29a983; font-weight:600;">Активен</span>
      </div>
      <div style="text-align:left; margin-left:6px; color:#fff; font-size:0.94rem;">
        До окончания: {{ tree.auto_water_until|date:"d.m H:i" }}
      </div>
    {% else %}
      {% if user_has_autowater_item %}
        <div class="inventory-list">
          {% for purchase in autowater_purchases %}
            <div class="inline-inventory-row">
              <img src="{% static 'images/watering_can.png' %}" alt="Автополив" class="inventory-img-small">
              <span class="inline-inventory-title">Автополив {{ purchase.item.duration|default:24 }}ч</span>
              <form class="autowater-form" data-purchase-id="{{ purchase.id }}" style="margin:0;">
                {% csrf_token %}
                <input type="hidden" name="tree_id" value="{{ tree.id }}">
                <button type="button"
                        class="inline-inventory-btn use-autowater-btn"
                        data-purchase-id="{{ purchase.id }}">
                  Активировать
                </button>
              </form>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="inline-inventory-row">
          <img src="{% static 'images/watering_can.png' %}" alt="Автополив" class="inventory-img-small">
          <span class="inline-inventory-title">Автополив 24ч</span>
          <button class="inline-inventory-btn" onclick="window.location.href='{% url 'shop:shop' %}'">Купить</button>
        </div>
      {% endif %}
    {% endif %}
  </div>
</div>




<div id="fertilizer-modal" class="custom-modal">
  <div class="custom-modal-content">
    <span class="custom-modal-close" data-modal-close>&times;</span>
    <h3 style="text-align:left; margin-left:8px;">Удобрение</h3>
    {% if is_fertilized %}
      <div class="inline-inventory-row">
        <img src="{% static 'images/Seed.png' %}" alt="Удобрение" class="inventory-img-small">
        <span class="inline-inventory-title">Удобрение {{ fertilizer_duration|default:24 }}ч</span>
        <span style="font-size:0.96rem; color:#29a983; font-weight:600;">Активно</span>
      </div>
      <div style="text-align:left; margin-left:6px; color:#fff; font-size:0.94rem;">
        До окончания: <span id="modal-fertilizer-timer"></span>
        <div class="modal-datetime">До {{ tree.fertilized_until|date:"d.m.Y H:i" }}</div>
      </div>
    {% else %}
      {% if user_has_fertilizer_item %}
        <div class="inventory-list">
          {% for purchase in fertilizer_purchases %}
            <div class="inline-inventory-row">
              <img src="{% static 'images/Seed.png' %}" alt="Удобрение" class="inventory-img-small">
              <span class="inline-inventory-title">Удобрение {{ purchase.item.duration }}</span>
              <form class="fertilizer-form" data-purchase-id="{{ purchase.id }}" style="margin:0;">
                {% csrf_token %}
                <input type="hidden" name="tree_id" value="{{ tree.id }}">
                <button type="button"
                        class="inline-inventory-btn use-fertilizer-btn"
                        data-purchase-id="{{ purchase.id }}">
                  Использовать
                </button>
              </form>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="inline-inventory-row">
          <img src="{% static 'images/Seed.png' %}" alt="Удобрение" class="inventory-img-small">
          <span class="inline-inventory-title">Удобрение 24ч</span>
          <button class="inline-inventory-btn" onclick="window.location.href='{% url 'shop:shop' %}'">Купить</button>
        </div>
      {% endif %}
    {% endif %}
  </div>
</div>


    <div id="status-modal" class="custom-modal">
  <div class="custom-modal-content" id="status-modal-content">
    <span class="custom-modal-close" onclick="hideStatusModal()">&times;</span>
    <div id="status-modal-body"></div>
    <button class="modal-action-btn" onclick="hideStatusModal()">OK</button>
  </div>
</div>






<script>
let shouldReload = false;

// Глобальная функция для показа модалки
function showStatusModal(message, type = "", reloadAfter = false) {
  let modal = document.getElementById('status-modal');
  let body = document.getElementById('status-modal-body');
  body.innerHTML = message;
  let content = modal.querySelector('.custom-modal-content');
  content.className = 'custom-modal-content';
  if (type === "success") content.classList.add('modal-success');
  if (type === "error") content.classList.add('modal-error');
  modal.classList.add('active');
  shouldReload = reloadAfter;
}

// Глобальная функция для скрытия модалки
function hideStatusModal() {
  document.getElementById('status-modal').classList.remove('active');
  if (shouldReload) {
    location.reload();
    shouldReload = false;
  }
}

document.addEventListener('DOMContentLoaded', function() {

  // Полить дерево
  document.querySelectorAll('.btn-water').forEach(btn => {
    btn.onclick = function() {
      let treeId = this.dataset.treeId;
      fetch(`/tree/${treeId}/water/`, {
        method: "POST",
        headers: {'X-CSRFToken': '{{ csrf_token }}'}
      })
      .then(r => r.json())
      .then(data => {
        showStatusModal(data.message || data.error, data.status, data.status === "success");
      });
    }
  });

  // Улучшить дерево
  document.querySelectorAll('.btn-upgrade').forEach(btn => {
    btn.onclick = function() {
      let treeId = this.dataset.treeId;
      fetch(`/tree/${treeId}/upgrade/`, {
        method: "POST",
        headers: {'X-CSRFToken': '{{ csrf_token }}'}
      })
      .then(r => r.json())
      .then(data => {
        showStatusModal(data.message || data.error, data.status, data.status === "success");
      });
    }
  });

  // Открытие модалок
  document.querySelectorAll('.open-modal-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      let id = btn.dataset.modal;
      let modal = document.getElementById(id);
      if (modal) modal.classList.add('active');
    });
  });

  // Закрытие по клику вне окна
  document.querySelectorAll('.custom-modal').forEach(modal => {
    modal.addEventListener('click', function(e) {
      if (e.target === this) {
        modal.classList.remove('active');
      }
    });
  });

  // Закрытие по крестику
  document.querySelectorAll('.custom-modal-close').forEach(btn => {
    btn.addEventListener('click', function() {
      this.closest('.custom-modal').classList.remove('active');
    });
  });

  // Использовать автополив
  document.querySelectorAll('.use-autowater-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      let purchaseId = this.dataset.purchaseId;
      let form = this.closest('form');
      let treeId = form.querySelector('[name="tree_id"]').value;
      fetch(`/shop/use/${purchaseId}/`, {
        method: "POST",
        headers: {'X-CSRFToken': '{{ csrf_token }}'},
        body: new URLSearchParams({tree_id: treeId})
      })
      .then(r => r.json())
      .then(data => {
        showStatusModal(data.message || data.error, data.status, data.status === "success");
      });
    });
  });

  // Использовать удобрение
  document.querySelectorAll('.use-fertilizer-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      let purchaseId = this.dataset.purchaseId;
      let form = this.closest('form');
      let treeId = form.querySelector('[name="tree_id"]').value;
      fetch(`/shop/use/${purchaseId}/`, {
        method: "POST",
        headers: {'X-CSRFToken': '{{ csrf_token }}'},
        body: new URLSearchParams({tree_id: treeId})
      })
      .then(r => r.json())
      .then(data => {
        showStatusModal(data.message || data.error, data.status, data.status === "success");
      });
    });
  });

  // Собрать доход
  document.querySelectorAll('.btn-collect').forEach(btn => {
    btn.onclick = function() {
      let treeId = this.dataset.treeId;
      fetch(`/tree/${treeId}/collect_income/`, {
        method: "POST",
        headers: {'X-CSRFToken': '{{ csrf_token }}'}
      })
      .then(r => r.json())
      .then(data => {
        showStatusModal(data.message || data.error, data.status, data.status === "success");
      });
    }
  });

  // Таймер для ручного полива
  {% if not can_water %}
    let secondsLeft = {{ time_left }};
    function formatTime(sec) {
      let h = Math.floor(sec / 3600);
      let m = Math.floor((sec % 3600) / 60);
      let s = sec % 60;
      return `${h}ч ${m}м ${s}с`;
    }
    function updateTimer() {
      if (secondsLeft > 0) {
        if (document.getElementById('timer')) {
          document.getElementById('timer').textContent = formatTime(secondsLeft);
        }
        secondsLeft--;
        setTimeout(updateTimer, 1000);
      } else {
        location.reload();
      }
    }
    updateTimer();
  {% endif %}

  // Таймер для автополива
  {% if is_auto_watered and auto_water_time_left %}
    let autoSec = {{ auto_water_time_left }};
    function updateModalAutoTimer() {
      if (autoSec >= 0 && document.getElementById('modal-autowater-timer')) {
        let h = Math.floor(autoSec / 3600), m = Math.floor((autoSec % 3600) / 60), s = autoSec % 60;
        document.getElementById('modal-autowater-timer').textContent = `${h}ч ${m}м ${s}с`;
        autoSec--;
        setTimeout(updateModalAutoTimer, 1000);
      }
    }
    updateModalAutoTimer();
  {% endif %}

  // Таймер для удобрения
  {% if is_fertilized and fertilizer_time_left %}
    let fertSec = {{ fertilizer_time_left }};
    function updateModalFertTimer() {
      if (fertSec >= 0 && document.getElementById('modal-fertilizer-timer')) {
        let h = Math.floor(fertSec / 3600), m = Math.floor((fertSec % 3600) / 60), s = fertSec % 60;
        document.getElementById('modal-fertilizer-timer').textContent = `${h}ч ${m}м ${s}с`;
        fertSec--;
        setTimeout(updateModalFertTimer, 1000);
      }
    }
    updateModalFertTimer();
  {% endif %}
});
</script>



{% endblock %}
